/* PyHTML Client v0.0.1 - https://github.com/reecelikesramen/pyhtml */
"use strict";var PyHTML=(()=>{var se=Object.defineProperty;var Ve=Object.getOwnPropertyDescriptor;var Xe=Object.getOwnPropertyNames;var Ge=Object.prototype.hasOwnProperty;var Ye=(i,e,t)=>e in i?se(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Je=(i,e)=>{for(var t in e)se(i,t,{get:e[t],enumerable:!0})},qe=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Xe(e))!Ge.call(i,s)&&s!==t&&se(i,s,{get:()=>e[s],enumerable:!(n=Ve(e,s))||n.enumerable});return i};var Ze=i=>qe(se({},"__esModule",{value:!0}),i);var c=(i,e,t)=>(Ye(i,typeof e!="symbol"?e+"":e,t),t);var $t={};Je($t,{DOMUpdater:()=>b,HTTPTransport:()=>F,PyHTMLApp:()=>ue,TransportManager:()=>_,WebSocketTransport:()=>W,WebTransportTransport:()=>P,app:()=>Ue});var L=class{constructor(){this.messageHandlers=[];this.statusHandlers=[];this.connected=!1}onMessage(e){this.messageHandlers.push(e)}onStatusChange(e){this.statusHandlers.push(e)}isConnected(){return this.connected}notifyHandlers(e){for(let t of this.messageHandlers)try{t(e)}catch(n){console.error("PyHTML: Error in message handler",n)}}notifyStatus(e){if(this.connected!==e){this.connected=e;for(let t of this.statusHandlers)try{t(e)}catch(n){console.error("PyHTML: Error in status handler",n)}}}};var P=class i extends L{constructor(t){super();this.name="WebTransport";this.transport=null;this.writer=null;this.encoder=new TextEncoder;this.decoder=new TextDecoder;this.url=t||this.getDefaultUrl()}getDefaultUrl(){return`https://${window.location.host}/_pyhtml/webtransport`}static isSupported(){return typeof WebTransport<"u"}async connect(){if(!i.isSupported())throw new Error("WebTransport not supported in this browser");try{let t={},n=window.PYHTML_CERT_HASH;n&&Array.isArray(n)&&(t.serverCertificateHashes=[{algorithm:"sha-256",value:new Uint8Array(n)}],console.log("PyHTML: Using explicit certificate hash for WebTransport")),this.transport=new WebTransport(this.url,t),await this.transport.ready,console.log("PyHTML: WebTransport ready"),this.connected=!0,this.startReading()}catch(t){throw this.handleDisconnect(),t}}async startReading(){if(!this.transport)return;let t=this.transport.incomingBidirectionalStreams.getReader();try{for(;;){let{value:n,done:s}=await t.read();if(s)break;this.handleStream(n)}}catch(n){this.connected&&(console.error("PyHTML: WebTransport read error",n),this.handleDisconnect())}}async handleStream(t){let n=t.readable.getReader();try{for(;;){let{value:s,done:r}=await n.read();if(r)break;if(s){let o=this.decoder.decode(s);try{let a=JSON.parse(o);this.notifyHandlers(a)}catch(a){console.error("PyHTML: Error parsing WebTransport message",a)}}}}catch(s){console.error("PyHTML: Stream read error",s)}}async send(t){if(!this.transport||!this.connected){console.warn("PyHTML: Cannot send message, WebTransport not connected");return}try{let n=await this.transport.createBidirectionalStream(),s=n.writable.getWriter(),r=this.encoder.encode(JSON.stringify(t));await s.write(r),await s.close(),this.handleStream(n)}catch(n){console.error("PyHTML: WebTransport send error",n)}}disconnect(){this.transport&&(this.transport.close(),this.transport=null),this.writer=null,this.connected=!1}handleDisconnect(){this.connected=!1,this.transport=null,this.writer=null}};function He(i){let e=i.length,t=0,n=0;for(;n<e;){let s=i.charCodeAt(n++);if(s&4294967168)if(!(s&4294965248))t+=2;else{if(s>=55296&&s<=56319&&n<e){let r=i.charCodeAt(n);(r&64512)===56320&&(++n,s=((s&1023)<<10)+(r&1023)+65536)}s&4294901760?t+=4:t+=3}else{t++;continue}}return t}function Qe(i,e,t){let n=i.length,s=t,r=0;for(;r<n;){let o=i.charCodeAt(r++);if(o&4294967168)if(!(o&4294965248))e[s++]=o>>6&31|192;else{if(o>=55296&&o<=56319&&r<n){let a=i.charCodeAt(r);(a&64512)===56320&&(++r,o=((o&1023)<<10)+(a&1023)+65536)}o&4294901760?(e[s++]=o>>18&7|240,e[s++]=o>>12&63|128,e[s++]=o>>6&63|128):(e[s++]=o>>12&15|224,e[s++]=o>>6&63|128)}else{e[s++]=o;continue}e[s++]=o&63|128}}var je=new TextEncoder,et=50;function tt(i,e,t){je.encodeInto(i,e.subarray(t))}function Le(i,e,t){i.length>et?tt(i,e,t):Qe(i,e,t)}var st=4096;function we(i,e,t){let n=e,s=n+t,r=[],o="";for(;n<s;){let a=i[n++];if(!(a&128))r.push(a);else if((a&224)===192){let h=i[n++]&63;r.push((a&31)<<6|h)}else if((a&240)===224){let h=i[n++]&63,m=i[n++]&63;r.push((a&31)<<12|h<<6|m)}else if((a&248)===240){let h=i[n++]&63,m=i[n++]&63,y=i[n++]&63,g=(a&7)<<18|h<<12|m<<6|y;g>65535&&(g-=65536,r.push(g>>>10&1023|55296),g=56320|g&1023),r.push(g)}else r.push(a);r.length>=st&&(o+=String.fromCharCode(...r),r.length=0)}return r.length>0&&(o+=String.fromCharCode(...r)),o}var nt=new TextDecoder,it=200;function rt(i,e,t){let n=i.subarray(e,e+t);return nt.decode(n)}function Ie(i,e,t){return t>it?rt(i,e,t):we(i,e,t)}var B=class{constructor(e,t){c(this,"type");c(this,"data");this.type=e,this.data=t}};var w=class i extends Error{constructor(e){super(e);let t=Object.create(i.prototype);Object.setPrototypeOf(this,t),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:i.name})}};function Pe(i,e,t){let n=t/4294967296,s=t;i.setUint32(e,n),i.setUint32(e+4,s)}function ne(i,e,t){let n=Math.floor(t/4294967296),s=t;i.setUint32(e,n),i.setUint32(e+4,s)}function ie(i,e){let t=i.getInt32(e),n=i.getUint32(e+4);return t*4294967296+n}function Be(i,e){let t=i.getUint32(e),n=i.getUint32(e+4);return t*4294967296+n}var ot=-1,at=4294967296-1,ct=17179869184-1;function lt({sec:i,nsec:e}){if(i>=0&&e>=0&&i<=ct)if(e===0&&i<=at){let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,i),t}else{let t=i/4294967296,n=i&4294967295,s=new Uint8Array(8),r=new DataView(s.buffer);return r.setUint32(0,e<<2|t&3),r.setUint32(4,n),s}else{let t=new Uint8Array(12),n=new DataView(t.buffer);return n.setUint32(0,e),ne(n,4,i),t}}function dt(i){let e=i.getTime(),t=Math.floor(e/1e3),n=(e-t*1e3)*1e6,s=Math.floor(n/1e9);return{sec:t+s,nsec:n-s*1e9}}function ht(i){if(i instanceof Date){let e=dt(i);return lt(e)}else return null}function ft(i){let e=new DataView(i.buffer,i.byteOffset,i.byteLength);switch(i.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:{let t=e.getUint32(0),n=e.getUint32(4),s=(t&3)*4294967296+n,r=t>>>2;return{sec:s,nsec:r}}case 12:{let t=ie(e,4),n=e.getUint32(0);return{sec:t,nsec:n}}default:throw new w(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${i.length}`)}}function ut(i){let e=ft(i);return new Date(e.sec*1e3+e.nsec/1e6)}var Ce={type:ot,encode:ht,decode:ut};var re=class re{constructor(){c(this,"__brand");c(this,"builtInEncoders",[]);c(this,"builtInDecoders",[]);c(this,"encoders",[]);c(this,"decoders",[]);this.register(Ce)}register({type:e,encode:t,decode:n}){if(e>=0)this.encoders[e]=t,this.decoders[e]=n;else{let s=-1-e;this.builtInEncoders[s]=t,this.builtInDecoders[s]=n}}tryToEncode(e,t){for(let n=0;n<this.builtInEncoders.length;n++){let s=this.builtInEncoders[n];if(s!=null){let r=s(e,t);if(r!=null){let o=-1-n;return new B(o,r)}}}for(let n=0;n<this.encoders.length;n++){let s=this.encoders[n];if(s!=null){let r=s(e,t);if(r!=null){let o=n;return new B(o,r)}}}return e instanceof B?e:null}decode(e,t,n){let s=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return s?s(e,t,n):new B(t,e)}};c(re,"defaultCodec",new re);var N=re;function pt(i){return i instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&i instanceof SharedArrayBuffer}function X(i){return i instanceof Uint8Array?i:ArrayBuffer.isView(i)?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):pt(i)?new Uint8Array(i):Uint8Array.from(i)}var gt=100,yt=2048,oe=class i{constructor(e){c(this,"extensionCodec");c(this,"context");c(this,"useBigInt64");c(this,"maxDepth");c(this,"initialBufferSize");c(this,"sortKeys");c(this,"forceFloat32");c(this,"ignoreUndefined");c(this,"forceIntegerToFloat");c(this,"pos");c(this,"view");c(this,"bytes");c(this,"entered",!1);this.extensionCodec=e?.extensionCodec??N.defaultCodec,this.context=e?.context,this.useBigInt64=e?.useBigInt64??!1,this.maxDepth=e?.maxDepth??gt,this.initialBufferSize=e?.initialBufferSize??yt,this.sortKeys=e?.sortKeys??!1,this.forceFloat32=e?.forceFloat32??!1,this.ignoreUndefined=e?.ignoreUndefined??!1,this.forceIntegerToFloat=e?.forceIntegerToFloat??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new i({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(e,t){if(t>this.maxDepth)throw new Error(`Too deep objects in depth ${t}`);e==null?this.encodeNil():typeof e=="boolean"?this.encodeBoolean(e):typeof e=="number"?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):typeof e=="string"?this.encodeString(e):this.useBigInt64&&typeof e=="bigint"?this.encodeBigInt64(e):this.encodeObject(e,t)}ensureBufferSizeToWrite(e){let t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(t*2)}resizeBuffer(e){let t=new ArrayBuffer(e),n=new Uint8Array(t),s=new DataView(t);n.set(this.bytes),this.view=s,this.bytes=n}encodeNil(){this.writeU8(192)}encodeBoolean(e){e===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<4294967296)this.writeU8(219),this.writeU32(e);else throw new Error(`Too long string: ${e} bytes in UTF-8`)}encodeString(e){let n=He(e);this.ensureBufferSizeToWrite(5+n),this.writeStringHeader(n),Le(e,this.bytes,this.pos),this.pos+=n}encodeObject(e,t){let n=this.extensionCodec.tryToEncode(e,this.context);if(n!=null)this.encodeExtension(n);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if(typeof e=="object")this.encodeMap(e,t);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`)}encodeBinary(e){let t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<4294967296)this.writeU8(198),this.writeU32(t);else throw new Error(`Too large binary: ${t}`);let n=X(e);this.writeU8a(n)}encodeArray(e,t){let n=e.length;if(n<16)this.writeU8(144+n);else if(n<65536)this.writeU8(220),this.writeU16(n);else if(n<4294967296)this.writeU8(221),this.writeU32(n);else throw new Error(`Too large array: ${n}`);for(let s of e)this.doEncode(s,t+1)}countWithoutUndefined(e,t){let n=0;for(let s of t)e[s]!==void 0&&n++;return n}encodeMap(e,t){let n=Object.keys(e);this.sortKeys&&n.sort();let s=this.ignoreUndefined?this.countWithoutUndefined(e,n):n.length;if(s<16)this.writeU8(128+s);else if(s<65536)this.writeU8(222),this.writeU16(s);else if(s<4294967296)this.writeU8(223),this.writeU32(s);else throw new Error(`Too large map object: ${s}`);for(let r of n){let o=e[r];this.ignoreUndefined&&o===void 0||(this.encodeString(r),this.doEncode(o,t+1))}}encodeExtension(e){if(typeof e.data=="function"){let n=e.data(this.pos+6),s=n.length;if(s>=4294967296)throw new Error(`Too large extension object: ${s}`);this.writeU8(201),this.writeU32(s),this.writeI8(e.type),this.writeU8a(n);return}let t=e.data.length;if(t===1)this.writeU8(212);else if(t===2)this.writeU8(213);else if(t===4)this.writeU8(214);else if(t===8)this.writeU8(215);else if(t===16)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else if(t<4294967296)this.writeU8(201),this.writeU32(t);else throw new Error(`Too large extension object: ${t}`);this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){let t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){this.ensureBufferSizeToWrite(8),Pe(this.view,this.pos,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),ne(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}};function z(i,e){return new oe(e).encodeSharedRef(i)}function ae(i){return`${i<0?"-":""}0x${Math.abs(i).toString(16).padStart(2,"0")}`}var mt=16,xt=16,ce=class{constructor(e=mt,t=xt){c(this,"hit",0);c(this,"miss",0);c(this,"caches");c(this,"maxKeyLength");c(this,"maxLengthPerKey");this.maxKeyLength=e,this.maxLengthPerKey=t,this.caches=[];for(let n=0;n<this.maxKeyLength;n++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,t,n){let s=this.caches[n-1];e:for(let r of s){let o=r.bytes;for(let a=0;a<n;a++)if(o[a]!==e[t+a])continue e;return r.str}return null}store(e,t){let n=this.caches[e.length-1],s={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=s:n.push(s)}decode(e,t,n){let s=this.find(e,t,n);if(s!=null)return this.hit++,s;this.miss++;let r=we(e,t,n),o=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(o,r),r}};var ve="array",J="map_key",Re="map_value",wt=i=>{if(typeof i=="string"||typeof i=="number")return i;throw new w("The type of key must be string or number but "+typeof i)},Te=class{constructor(){c(this,"stack",[]);c(this,"stackHeadPosition",-1)}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(e){let t=this.getUninitializedStateFromPool();t.type=ve,t.position=0,t.size=e,t.array=new Array(e)}pushMapState(e){let t=this.getUninitializedStateFromPool();t.type=J,t.readCount=0,t.size=e,t.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){let e={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(e)}return this.stack[this.stackHeadPosition]}release(e){if(this.stack[this.stackHeadPosition]!==e)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(e.type===ve){let n=e;n.size=0,n.array=void 0,n.position=0,n.type=void 0}if(e.type===J||e.type===Re){let n=e;n.size=0,n.map=void 0,n.readCount=0,n.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}},Y=-1,Se=new DataView(new ArrayBuffer(0)),vt=new Uint8Array(Se.buffer);try{Se.getInt8(0)}catch(i){if(!(i instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}var De=new RangeError("Insufficient data"),Tt=new ce,le=class i{constructor(e){c(this,"extensionCodec");c(this,"context");c(this,"useBigInt64");c(this,"rawStrings");c(this,"maxStrLength");c(this,"maxBinLength");c(this,"maxArrayLength");c(this,"maxMapLength");c(this,"maxExtLength");c(this,"keyDecoder");c(this,"mapKeyConverter");c(this,"totalPos",0);c(this,"pos",0);c(this,"view",Se);c(this,"bytes",vt);c(this,"headByte",Y);c(this,"stack",new Te);c(this,"entered",!1);this.extensionCodec=e?.extensionCodec??N.defaultCodec,this.context=e?.context,this.useBigInt64=e?.useBigInt64??!1,this.rawStrings=e?.rawStrings??!1,this.maxStrLength=e?.maxStrLength??4294967295,this.maxBinLength=e?.maxBinLength??4294967295,this.maxArrayLength=e?.maxArrayLength??4294967295,this.maxMapLength=e?.maxMapLength??4294967295,this.maxExtLength=e?.maxExtLength??4294967295,this.keyDecoder=e?.keyDecoder!==void 0?e.keyDecoder:Tt,this.mapKeyConverter=e?.mapKeyConverter??wt}clone(){return new i({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=Y,this.stack.reset()}setBuffer(e){let t=X(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}appendBuffer(e){if(this.headByte===Y&&!this.hasRemaining(1))this.setBuffer(e);else{let t=this.bytes.subarray(this.pos),n=X(e),s=new Uint8Array(t.length+n.length);s.set(t),s.set(n,t.length),this.setBuffer(s)}}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){let{view:t,pos:n}=this;return new RangeError(`Extra ${t.byteLength-n} of ${t.byteLength} byte(s) found at buffer[${e}]`)}decode(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);let t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}*decodeMulti(e){if(this.entered){yield*this.clone().decodeMulti(e);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(e){if(this.entered)return this.clone().decodeAsync(e);try{this.entered=!0;let t=!1,n;for await(let a of e){if(t)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(a);try{n=this.doDecodeSync(),t=!0}catch(h){if(!(h instanceof RangeError))throw h}this.totalPos+=this.pos}if(t){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return n}let{headByte:s,pos:r,totalPos:o}=this;throw new RangeError(`Insufficient data in parsing ${ae(s)} at ${o} (${r} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async*decodeMultiAsync(e,t){if(this.entered){yield*this.clone().decodeMultiAsync(e,t);return}try{this.entered=!0;let n=t,s=-1;for await(let r of e){if(t&&s===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(r),n&&(s=this.readArraySize(),n=!1,this.complete());try{for(;yield this.doDecodeSync(),--s!==0;);}catch(o){if(!(o instanceof RangeError))throw o}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){e:for(;;){let e=this.readHeadByte(),t;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){let s=e-128;if(s!==0){this.pushMapState(s),this.complete();continue e}else t={}}else if(e<160){let s=e-144;if(s!==0){this.pushArrayState(s),this.complete();continue e}else t=[]}else{let s=e-160;t=this.decodeString(s,0)}else if(e===192)t=null;else if(e===194)t=!1;else if(e===195)t=!0;else if(e===202)t=this.readF32();else if(e===203)t=this.readF64();else if(e===204)t=this.readU8();else if(e===205)t=this.readU16();else if(e===206)t=this.readU32();else if(e===207)this.useBigInt64?t=this.readU64AsBigInt():t=this.readU64();else if(e===208)t=this.readI8();else if(e===209)t=this.readI16();else if(e===210)t=this.readI32();else if(e===211)this.useBigInt64?t=this.readI64AsBigInt():t=this.readI64();else if(e===217){let s=this.lookU8();t=this.decodeString(s,1)}else if(e===218){let s=this.lookU16();t=this.decodeString(s,2)}else if(e===219){let s=this.lookU32();t=this.decodeString(s,4)}else if(e===220){let s=this.readU16();if(s!==0){this.pushArrayState(s),this.complete();continue e}else t=[]}else if(e===221){let s=this.readU32();if(s!==0){this.pushArrayState(s),this.complete();continue e}else t=[]}else if(e===222){let s=this.readU16();if(s!==0){this.pushMapState(s),this.complete();continue e}else t={}}else if(e===223){let s=this.readU32();if(s!==0){this.pushMapState(s),this.complete();continue e}else t={}}else if(e===196){let s=this.lookU8();t=this.decodeBinary(s,1)}else if(e===197){let s=this.lookU16();t=this.decodeBinary(s,2)}else if(e===198){let s=this.lookU32();t=this.decodeBinary(s,4)}else if(e===212)t=this.decodeExtension(1,0);else if(e===213)t=this.decodeExtension(2,0);else if(e===214)t=this.decodeExtension(4,0);else if(e===215)t=this.decodeExtension(8,0);else if(e===216)t=this.decodeExtension(16,0);else if(e===199){let s=this.lookU8();t=this.decodeExtension(s,1)}else if(e===200){let s=this.lookU16();t=this.decodeExtension(s,2)}else if(e===201){let s=this.lookU32();t=this.decodeExtension(s,4)}else throw new w(`Unrecognized type byte: ${ae(e)}`);this.complete();let n=this.stack;for(;n.length>0;){let s=n.top();if(s.type===ve)if(s.array[s.position]=t,s.position++,s.position===s.size)t=s.array,n.release(s);else continue e;else if(s.type===J){if(t==="__proto__")throw new w("The key __proto__ is not allowed");s.key=this.mapKeyConverter(t),s.type=Re;continue e}else if(s.map[s.key]=t,s.readCount++,s.readCount===s.size)t=s.map,n.release(s);else{s.key=null,s.type=J;continue e}}return t}}readHeadByte(){return this.headByte===Y&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=Y}readArraySize(){let e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:{if(e<160)return e-144;throw new w(`Unrecognized array type byte: ${ae(e)}`)}}}pushMapState(e){if(e>this.maxMapLength)throw new w(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(e)}pushArrayState(e){if(e>this.maxArrayLength)throw new w(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(e)}decodeString(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}decodeUtf8String(e,t){if(e>this.maxStrLength)throw new w(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+t+e)throw De;let n=this.pos+t,s;return this.stateIsMapKey()&&this.keyDecoder?.canBeCached(e)?s=this.keyDecoder.decode(this.bytes,n,e):s=Ie(this.bytes,n,e),this.pos+=t+e,s}stateIsMapKey(){return this.stack.length>0?this.stack.top().type===J:!1}decodeBinary(e,t){if(e>this.maxBinLength)throw new w(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+t))throw De;let n=this.pos+t,s=this.bytes.subarray(n,n+e);return this.pos+=t+e,s}decodeExtension(e,t){if(e>this.maxExtLength)throw new w(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);let n=this.view.getInt8(this.pos+t),s=this.decodeBinary(e,t+1);return this.extensionCodec.decode(s,n,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){let e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){let e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){let e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){let e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){let e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){let e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){let e=Be(this.view,this.pos);return this.pos+=8,e}readI64(){let e=ie(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){let e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){let e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){let e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){let e=this.view.getFloat64(this.pos);return this.pos+=8,e}};function C(i,e){return new le(e).decode(i)}var W=class extends L{constructor(t){super();this.name="WebSocket";this.socket=null;this.reconnectAttempts=0;this.maxReconnectDelay=5e3;this.shouldReconnect=!0;this.url=t||this.getDefaultUrl()}getDefaultUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_pyhtml/ws`}connect(){return new Promise((t,n)=>{try{this.socket=new WebSocket(this.url),this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{console.log("PyHTML: WebSocket connected"),this.notifyStatus(!0),this.reconnectAttempts=0,t()},this.socket.onmessage=s=>{try{let r=C(s.data);this.notifyHandlers(r)}catch(r){console.error("PyHTML: Error parsing WebSocket message",r)}},this.socket.onclose=()=>{console.log("PyHTML: WebSocket disconnected"),this.notifyStatus(!1),this.shouldReconnect&&this.scheduleReconnect()},this.socket.onerror=s=>{console.error("PyHTML: WebSocket error",s),this.connected||n(new Error("WebSocket connection failed"))}}catch(s){n(s)}})}send(t){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(z(t)):console.warn("PyHTML: Cannot send message, WebSocket not open")}disconnect(){this.shouldReconnect=!1,this.socket&&(this.socket.close(),this.socket=null),this.notifyStatus(!1)}scheduleReconnect(){let t=Math.min(1e3*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);console.log(`PyHTML: Reconnecting in ${t}ms...`),setTimeout(()=>{this.reconnectAttempts++,this.connect().catch(()=>{})},t)}};var F=class extends L{constructor(t){super();this.name="HTTP";this.polling=!1;this.pollAbortController=null;this.sessionId=null;this.baseUrl=t||`${window.location.origin}/_pyhtml`}async connect(){try{let t=await fetch(`${this.baseUrl}/session`,{method:"POST",headers:{"Content-Type":"application/x-msgpack",Accept:"application/x-msgpack"},body:z({path:window.location.pathname+window.location.search})});if(!t.ok)throw new Error(`HTTP session init failed: ${t.status}`);let n=await t.arrayBuffer(),s=C(n);this.sessionId=s.sessionId,console.log("PyHTML: HTTP transport connected"),this.notifyStatus(!0),this.startPolling()}catch(t){throw console.error("PyHTML: HTTP transport connection failed",t),t}}async startPolling(){if(!this.polling)for(this.polling=!0;this.polling&&this.connected;)try{this.pollAbortController=new AbortController;let t=await fetch(`${this.baseUrl}/poll?session=${this.sessionId}`,{method:"GET",signal:this.pollAbortController.signal,headers:{Accept:"application/x-msgpack"}});if(!t.ok){if(t.status===404){console.warn("PyHTML: HTTP session expired, reconnecting..."),this.notifyStatus(!1),await this.connect();return}throw new Error(`Poll failed: ${t.status}`)}let n=await t.arrayBuffer(),s=C(n);for(let r of s)this.notifyHandlers(r)}catch(t){if(t instanceof Error&&t.name==="AbortError")break;console.error("PyHTML: HTTP poll error",t),await this.sleep(1e3)}}async send(t){if(!this.connected||!this.sessionId){console.warn("PyHTML: Cannot send message, HTTP transport not connected");return}try{let n=await fetch(`${this.baseUrl}/event`,{method:"POST",headers:{"Content-Type":"application/x-msgpack",Accept:"application/x-msgpack","X-PyHTML-Session":this.sessionId},body:z(t)});if(!n.ok)throw new Error(`Event send failed: ${n.status}`);let s=await n.arrayBuffer(),r=C(s);this.notifyHandlers(r)}catch(n){console.error("PyHTML: HTTP send error",n)}}disconnect(){this.polling=!1,this.notifyStatus(!1),this.pollAbortController&&(this.pollAbortController.abort(),this.pollAbortController=null),this.sessionId=null}sleep(t){return new Promise(n=>setTimeout(n,t))}};var St={enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},_=class{constructor(e={}){this.transport=null;this.messageHandlers=[];this.statusHandlers=[];this.config={...St,...e}}async connect(){let e=this.getTransportPriority();for(let t of e)try{console.log(`PyHTML: Trying ${t.name}...`),this.transport=new t;for(let n of this.messageHandlers)this.transport.onMessage(n);this.transport.onStatusChange(n=>{this.notifyStatusHandlers(n)}),await this.transport.connect(),console.log(`PyHTML: Connected via ${this.transport.name}`);return}catch(n){console.warn(`PyHTML: ${t.name} failed, trying next...`,n),this.transport=null}throw new Error("PyHTML: All transports failed")}getTransportPriority(){let e=[];return this.config.enableWebTransport&&P.isSupported()&&window.location.protocol==="https:"&&e.push(P),this.config.enableWebSocket&&typeof WebSocket<"u"&&e.push(W),this.config.enableHTTP&&e.push(F),e}send(e){this.transport?this.transport.send(e):console.warn("PyHTML: No active transport")}onMessage(e){this.messageHandlers.push(e),this.transport&&this.transport.onMessage(e)}onStatusChange(e){this.statusHandlers.push(e)}notifyStatusHandlers(e){for(let t of this.statusHandlers)t(e)}disconnect(){this.transport&&(this.transport.disconnect(),this.transport=null,this.notifyStatusHandlers(!1))}getActiveTransport(){return this.transport?.name||null}isConnected(){return this.transport?.isConnected()||!1}};var $e=11;function bt(i,e){var t=e.attributes,n,s,r,o,a;if(!(e.nodeType===$e||i.nodeType===$e)){for(var h=t.length-1;h>=0;h--)n=t[h],s=n.name,r=n.namespaceURI,o=n.value,r?(s=n.localName||s,a=i.getAttributeNS(r,s),a!==o&&(n.prefix==="xmlns"&&(s=n.name),i.setAttributeNS(r,s,o))):(a=i.getAttribute(s),a!==o&&i.setAttribute(s,o));for(var m=i.attributes,y=m.length-1;y>=0;y--)n=m[y],s=n.name,r=n.namespaceURI,r?(s=n.localName||s,e.hasAttributeNS(r,s)||i.removeAttributeNS(r,s)):e.hasAttribute(s)||i.removeAttribute(s)}}var de,Et="http://www.w3.org/1999/xhtml",v=typeof document>"u"?void 0:document,Ut=!!v&&"content"in v.createElement("template"),Mt=!!v&&v.createRange&&"createContextualFragment"in v.createRange();function At(i){var e=v.createElement("template");return e.innerHTML=i,e.content.childNodes[0]}function kt(i){de||(de=v.createRange(),de.selectNode(v.body));var e=de.createContextualFragment(i);return e.childNodes[0]}function Ht(i){var e=v.createElement("body");return e.innerHTML=i,e.childNodes[0]}function Lt(i){return i=i.trim(),Ut?At(i):Mt?kt(i):Ht(i)}function he(i,e){var t=i.nodeName,n=e.nodeName,s,r;return t===n?!0:(s=t.charCodeAt(0),r=n.charCodeAt(0),s<=90&&r>=97?t===n.toUpperCase():r<=90&&s>=97?n===t.toUpperCase():!1)}function It(i,e){return!e||e===Et?v.createElement(i):v.createElementNS(e,i)}function Pt(i,e){for(var t=i.firstChild;t;){var n=t.nextSibling;e.appendChild(t),t=n}return e}function be(i,e,t){i[t]!==e[t]&&(i[t]=e[t],i[t]?i.setAttribute(t,""):i.removeAttribute(t))}var Ne={OPTION:function(i,e){var t=i.parentNode;if(t){var n=t.nodeName.toUpperCase();n==="OPTGROUP"&&(t=t.parentNode,n=t&&t.nodeName.toUpperCase()),n==="SELECT"&&!t.hasAttribute("multiple")&&(i.hasAttribute("selected")&&!e.selected&&(i.setAttribute("selected","selected"),i.removeAttribute("selected")),t.selectedIndex=-1)}be(i,e,"selected")},INPUT:function(i,e){be(i,e,"checked"),be(i,e,"disabled"),i.value!==e.value&&(i.value=e.value),e.hasAttribute("value")||i.removeAttribute("value")},TEXTAREA:function(i,e){var t=e.value;i.value!==t&&(i.value=t);var n=i.firstChild;if(n){var s=n.nodeValue;if(s==t||!t&&s==i.placeholder)return;n.nodeValue=t}},SELECT:function(i,e){if(!e.hasAttribute("multiple")){for(var t=-1,n=0,s=i.firstChild,r,o;s;)if(o=s.nodeName&&s.nodeName.toUpperCase(),o==="OPTGROUP")r=s,s=r.firstChild,s||(s=r.nextSibling,r=null);else{if(o==="OPTION"){if(s.hasAttribute("selected")){t=n;break}n++}s=s.nextSibling,!s&&r&&(s=r.nextSibling,r=null)}i.selectedIndex=t}}},q=1,ze=11,We=3,Fe=8;function I(){}function Bt(i){if(i)return i.getAttribute&&i.getAttribute("id")||i.id}function Ct(i){return function(t,n,s){if(s||(s={}),typeof n=="string")if(t.nodeName==="#document"||t.nodeName==="HTML"||t.nodeName==="BODY"){var r=n;n=v.createElement("html"),n.innerHTML=r}else n=Lt(n);else n.nodeType===ze&&(n=n.firstElementChild);var o=s.getNodeKey||Bt,a=s.onBeforeNodeAdded||I,h=s.onNodeAdded||I,m=s.onBeforeElUpdated||I,y=s.onElUpdated||I,g=s.onBeforeNodeDiscarded||I,U=s.onNodeDiscarded||I,K=s.onBeforeElChildrenUpdated||I,T=s.skipFromChildren||I,V=s.addChild||function(l,d){return l.appendChild(d)},D=s.childrenOnly===!0,S=Object.create(null),M=[];function A(l){M.push(l)}function Me(l,d){if(l.nodeType===q)for(var p=l.firstChild;p;){var f=void 0;d&&(f=o(p))?A(f):(U(p),p.firstChild&&Me(p,d)),p=p.nextSibling}}function Z(l,d,p){g(l)!==!1&&(d&&d.removeChild(l),U(l),Me(l,p))}function pe(l){if(l.nodeType===q||l.nodeType===ze)for(var d=l.firstChild;d;){var p=o(d);p&&(S[p]=d),pe(d),d=d.nextSibling}}pe(t);function ge(l){h(l);for(var d=l.firstChild;d;){var p=d.nextSibling,f=o(d);if(f){var u=S[f];u&&he(d,u)?(d.parentNode.replaceChild(u,d),Q(u,d)):ge(d)}else ge(d);d=p}}function _e(l,d,p){for(;d;){var f=d.nextSibling;(p=o(d))?A(p):Z(d,l,!0),d=f}}function Q(l,d,p){var f=o(d);if(f&&delete S[f],!p){var u=m(l,d);if(u===!1||(u instanceof HTMLElement&&(l=u,pe(l)),i(l,d),y(l),K(l,d)===!1))return}l.nodeName!=="TEXTAREA"?Oe(l,d):Ne.TEXTAREA(l,d)}function Oe(l,d){var p=T(l,d),f=d.firstChild,u=l.firstChild,R,E,$,ee,k;e:for(;f;){for(ee=f.nextSibling,R=o(f);!p&&u;){if($=u.nextSibling,f.isSameNode&&f.isSameNode(u)){f=ee,u=$;continue e}E=o(u);var te=u.nodeType,H=void 0;if(te===f.nodeType&&(te===q?(R?R!==E&&((k=S[R])?$===k?H=!1:(l.insertBefore(k,u),E?A(E):Z(u,l,!0),u=k,E=o(u)):H=!1):E&&(H=!1),H=H!==!1&&he(u,f),H&&Q(u,f)):(te===We||te==Fe)&&(H=!0,u.nodeValue!==f.nodeValue&&(u.nodeValue=f.nodeValue))),H){f=ee,u=$;continue e}E?A(E):Z(u,l,!0),u=$}if(R&&(k=S[R])&&he(k,f))p||V(l,k),Q(k,f);else{var xe=a(f);xe!==!1&&(xe&&(f=xe),f.actualize&&(f=f.actualize(l.ownerDocument||v)),V(l,f),ge(f))}f=ee,u=$}_e(l,u,E);var ke=Ne[l.nodeName];ke&&ke(l,d)}var x=t,j=x.nodeType,Ae=n.nodeType;if(!D){if(j===q)Ae===q?he(t,n)||(U(t),x=Pt(t,It(n.nodeName,n.namespaceURI))):x=n;else if(j===We||j===Fe){if(Ae===j)return x.nodeValue!==n.nodeValue&&(x.nodeValue=n.nodeValue),x;x=n}}if(x===n)U(t);else{if(n.isSameNode&&n.isSameNode(x))return;if(Q(x,n,D),M)for(var ye=0,Ke=M.length;ye<Ke;ye++){var me=S[M[ye]];me&&Z(me,me.parentNode,!1)}}return!D&&x!==t&&t.parentNode&&(x.actualize&&(x=x.actualize(t.ownerDocument||v)),t.parentNode.replaceChild(x,t)),x}}var Dt=Ct(bt),Ee=Dt;var O=class O{getNodeKey(e){if(e instanceof HTMLElement){for(let t of e.attributes)if(t.name.startsWith("data-on-"))return`${e.tagName}-${t.name}-${t.value}`;if(e.id&&!e.id.startsWith("pyhtml-uid-"))return e.id;if((e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement)&&e.name)return`${e.tagName}-name-${e.name}`}}getElementSelector(e){if(e.id)return`#${e.id}`;let t=[],n=e;for(;n&&n!==document.body&&t.length<5;){let s=n.tagName.toLowerCase();if(n.id){s=`#${n.id}`,t.unshift(s);break}(n instanceof HTMLInputElement||n instanceof HTMLSelectElement||n instanceof HTMLTextAreaElement)&&n.name&&(s+=`[name="${n.name}"]`);for(let r of n.attributes)if(r.name.startsWith("data-on-")){s+=`[${r.name}="${r.value}"]`;break}if(n.parentElement){let o=Array.from(n.parentElement.children).filter(a=>a.tagName===n.tagName);if(o.length>1){let a=o.indexOf(n)+1;s+=`:nth-of-type(${a})`}}t.unshift(s),n=n.parentElement}return t.join(" > ")}captureFocusState(){let e=document.activeElement;if(!e||e===document.body||e===document.documentElement)return null;let t={selector:this.getElementSelector(e),id:e.id||null,tagName:e.tagName,selectionStart:null,selectionEnd:null,scrollTop:0,scrollLeft:0,value:""};return(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)&&(t.selectionStart=e.selectionStart,t.selectionEnd=e.selectionEnd,t.scrollTop=e.scrollTop,t.scrollLeft=e.scrollLeft,t.value=e.value),t}restoreFocusState(e){if(!e)return;let t=null;if(e.id&&(t=document.getElementById(e.id)),!t&&e.selector)try{t=document.querySelector(e.selector)}catch{}if(t&&(t.focus(),t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)){if(e.value&&t.value!==e.value&&(t.value=e.value),e.selectionStart!==null&&e.selectionEnd!==null)try{t.setSelectionRange(e.selectionStart,e.selectionEnd)}catch{}t.scrollTop=e.scrollTop,t.scrollLeft=e.scrollLeft}}update(e){O.isUpdating=!0,console.log("[DOMUpdater] Starting update, isUpdating =",O.isUpdating);try{let t=this.captureFocusState(),n=new Map;if(document.querySelectorAll("input, select, textarea").forEach((s,r)=>{let o=this.getNodeKey(s)||`form-el-${r}`;s instanceof HTMLInputElement?n.set(o,{value:s.value,checked:s.type==="checkbox"||s.type==="radio"?s.checked:void 0}):s instanceof HTMLSelectElement?n.set(o,{value:s.value,selectedIndex:s.selectedIndex}):s instanceof HTMLTextAreaElement&&n.set(o,{value:s.value})}),Ee){try{Ee(document.documentElement,e,{getNodeKey:s=>this.getNodeKey(s),onBeforeElUpdated:(s,r)=>(s instanceof HTMLInputElement&&r instanceof HTMLInputElement&&(s.type==="checkbox"||s.type==="radio"?r.checked=s.checked:r.value=s.value),s instanceof HTMLTextAreaElement&&r instanceof HTMLTextAreaElement&&(r.value=s.value),s instanceof HTMLSelectElement&&r instanceof HTMLSelectElement&&(s.value&&Array.from(r.options).some(o=>o.value===s.value)?r.value=s.value:s.selectedIndex>=0&&s.selectedIndex<r.options.length&&(r.selectedIndex=s.selectedIndex)),s.id&&s.id.startsWith("pyhtml-uid-")&&!r.id&&(r.id=s.id),!0),onBeforeNodeDiscarded:()=>!0})}catch(s){console.error("Morphdom failed:",s),document.open(),document.write(e),document.close()}this.restoreFocusState(t)}else document.open(),document.write(e),document.close()}finally{setTimeout(()=>{O.isUpdating=!1},0)}}};O.isUpdating=!1;var b=O;var fe=class{constructor(e){this.debouncers=new Map;this.throttlers=new Map;this.supportedEvents=["click","submit","input","change","keydown","keyup","focus","blur","mouseenter","mouseleave","scroll","contextmenu"];this.suppressDuringUpdate=["focus","blur","mouseenter","mouseleave"];this.app=e}init(){this.supportedEvents.forEach(e=>{let t=e==="mouseenter"||e==="mouseleave"||e==="focus"||e==="blur"||e==="scroll"?{capture:!0}:void 0;document.addEventListener(e,n=>this.handleEvent(n),t)})}getHandlers(e,t){let n=`data-on-${t}`,s=e.getAttribute(n);if(!s)return[];if(s.trim().startsWith("["))try{let r=JSON.parse(s);if(Array.isArray(r))return r.map(o=>({name:o.handler,modifiers:o.modifiers||[],args:o.args}))}catch(r){console.error("Error parsing event handlers:",r)}else{let r=e.getAttribute(`data-modifiers-${t}`),o=r?r.split(" ").filter(a=>a):[];return[{name:s,modifiers:o,args:void 0}]}return[]}async handleEvent(e){let t=e.type;if(b.isUpdating&&this.suppressDuringUpdate.includes(t)){console.log("[Handler] SUPPRESSING event during update:",t,"isUpdating=",b.isUpdating);return}console.log("[Handler] Processing event:",t,"isUpdating=",b.isUpdating);let n=e.composedPath?e.composedPath():[],s=!1;for(let r of n){if(s)break;if(r instanceof HTMLElement){let o=r,a=this.getHandlers(o,t);if(a.length>0){console.log("[handleEvent] Found handlers on",o.tagName,a);for(let h of a)!h.modifiers.includes("window")&&!h.modifiers.includes("outside")&&(this.processEvent(o,t,h.name,h.modifiers,e,h.args),e.cancelBubble&&(s=!0))}}}this.handleGlobalEvent(e)}handleGlobalEvent(e){let t=e.type,n=`[data-modifiers-${t}*="window"]`,s=`[data-modifiers-${t}*="outside"]`;document.querySelectorAll(`${n}, ${s}`).forEach(o=>{if(!(o instanceof HTMLElement))return;let a=this.getHandlers(o,t);for(let h of a)if(h.modifiers.includes("window")&&this.processEvent(o,t,h.name,h.modifiers,e,h.args),h.modifiers.includes("outside")){let m=e.target;m&&!o.contains(m)&&this.processEvent(o,t,h.name,h.modifiers,e,h.args)}})}processEvent(e,t,n,s,r,o){if(console.log("[processEvent]",t,"handler:",n,"modifiers:",s),(s.includes("prevent")||t==="submit")&&(console.log("[processEvent] Calling preventDefault"),r.preventDefault()),s.includes("stop")&&r.stopPropagation(),s.includes("self")&&r.target!==e||s.includes("shift")&&!r.shiftKey||s.includes("ctrl")&&!r.ctrlKey||s.includes("alt")&&!r.altKey||s.includes("meta")&&!r.metaKey||s.includes("cmd")&&!r.metaKey)return;if(r instanceof KeyboardEvent){let g=["enter","escape","space","tab","up","down","left","right"],U=["shift","ctrl","alt","meta","cmd","window","outside","prevent","stop","self","debounce","throttle"],K=s.filter(T=>U.includes(T)||T.startsWith("debounce")||T.startsWith("throttle")||T.endsWith("ms")?!1:g.includes(T)||T.length===1);if(K.length>0){let T=r.key.toLowerCase();console.log("[processEvent] Key check. Pressed:",T,"Modifiers:",K);let V={escape:"escape",esc:"escape",enter:"enter",space:" ",spacebar:" "," ":" ",tab:"tab",up:"arrowup",arrowup:"arrowup",down:"arrowdown",arrowdown:"arrowdown",left:"arrowleft",arrowleft:"arrowleft",right:"arrowright",arrowright:"arrowright"},D=V[T]||T,S=!1;for(let M of K){let A=V[M]||M;if(console.log("[processEvent] Comparing constraint:",M,"->",A,"vs",D,"code:",r.code),A===D){S=!0;break}if(r.code&&r.code.toLowerCase()===`key${A}`){S=!0;break}}if(!S){console.log("[processEvent] No key match found.");return}}}let a=s.find(g=>g.startsWith("debounce")),h=s.find(g=>g.startsWith("throttle")),y=`${e.id||this.getUniqueId(e)}-${t}-${n}`;if(a){let g=this.parseDuration(s,250);this.debouncers.has(y)&&window.clearTimeout(this.debouncers.get(y));let U=window.setTimeout(()=>{this.debouncers.delete(y),this.dispatchEvent(e,t,n,r,o)},g);this.debouncers.set(y,U);return}if(h){let g=this.parseDuration(s,250);if(this.throttlers.has(y))return;this.throttlers.set(y,Date.now()),this.dispatchEvent(e,t,n,r,o),window.setTimeout(()=>{this.throttlers.delete(y)},g);return}this.dispatchEvent(e,t,n,r,o)}dispatchEvent(e,t,n,s,r){let o={};r&&r.length>0?r.forEach((h,m)=>{o[`arg${m}`]=h}):o=this.getArgs(e);let a={type:t,id:e.id,args:o};if(e instanceof HTMLInputElement?(a.value=e.value,(e.type==="checkbox"||e.type==="radio")&&(a.checked=e.checked)):(e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)&&(a.value=e.value),s instanceof KeyboardEvent&&(a.key=s.key,a.keyCode=s.keyCode),t==="submit"&&e instanceof HTMLFormElement){let h=new FormData(e),m={};h.forEach((y,g)=>{y instanceof File||(m[g]=y.toString())}),a.formData=m}this.app.sendEvent(n,a)}parseDuration(e,t){let n=e.findIndex(a=>a.startsWith("debounce")),s=e.findIndex(a=>a.startsWith("throttle")),r=n!==-1?n:s;if(r!==-1&&e[r+1]){let a=e[r+1];if(a.endsWith("ms")){let h=parseInt(a);if(!isNaN(h))return h}}let o=e[r];if(o&&o.includes("-")){let a=o.split("-"),h=parseInt(a[1]);if(!isNaN(h))return h}return t}getUniqueId(e){return e.id||(e.id="pyhtml-uid-"+Math.random().toString(36).substr(2,9)),e.id}getArgs(e){let t={};if(e instanceof HTMLElement){for(let n in e.dataset)if(n.startsWith("arg"))try{t[n]=JSON.parse(e.dataset[n]||"null")}catch{t[n]=e.dataset[n]}}return t}};var Rt={autoInit:!0,enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},ue=class{constructor(e={}){this.initialized=!1;this.siblingPaths=[];this.pathRegexes=[];this.pjaxEnabled=!1;this.statusOverlay=null;this.isConnected=!1;this.config={...Rt,...e},this.transport=new _(this.config),this.updater=new b,this.eventHandler=new fe(this)}async init(){if(!this.initialized){this.initialized=!0,this.transport.onMessage(e=>this.handleMessage(e)),this.transport.onStatusChange(e=>this.handleStatusChange(e)),this.createStatusOverlay(),this.handleStatusChange(!1);try{await this.transport.connect()}catch(e){console.error("PyHTML: Failed to connect:",e)}this.loadSPAMetadata(),this.setupSPANavigation(),this.eventHandler.init(),console.log(`PyHTML: Initialized (transport: ${this.transport.getActiveTransport()}, spa_paths: ${this.siblingPaths.length}, pjax: ${this.pjaxEnabled})`)}}loadSPAMetadata(){let e=document.getElementById("_pyhtml_spa_meta");if(e)try{let t=JSON.parse(e.textContent||"{}");this.siblingPaths=t.sibling_paths||[],this.pjaxEnabled=!!t.enable_pjax,this.pathRegexes=this.siblingPaths.map(n=>this.patternToRegex(n))}catch(t){console.warn("PyHTML: Failed to parse SPA metadata",t)}}createStatusOverlay(){this.statusOverlay=document.createElement("div"),this.statusOverlay.style.cssText=`
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 14px;
            z-index: 10000;
            display: none;
            transition: opacity 0.3s;
            pointer-events: none;
        `,document.body.appendChild(this.statusOverlay)}handleStatusChange(e){this.isConnected=e,this.statusOverlay&&(e?this.statusOverlay.style.display="none":(this.statusOverlay.textContent="Connection Lost - Reconnecting...",this.statusOverlay.style.display="block"))}patternToRegex(e){let t=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&");return t=t.replace(/:(\w+)(:\w+)?/g,"([^/]+)"),t=t.replace(/\{(\w+)(:\w+)?\}/g,"([^/]+)"),new RegExp(`^${t}$`)}isSiblingPath(e){return this.pathRegexes.some(t=>t.test(e))}setupSPANavigation(){this.siblingPaths.length===0&&!this.pjaxEnabled||(document.addEventListener("click",e=>{let t=e.target.closest("a[href]");if(!t||t.origin!==window.location.origin||t.hasAttribute("download")||t.target==="_blank")return;let n=!1;(this.pjaxEnabled||this.isSiblingPath(t.pathname))&&(n=!0),n&&(e.preventDefault(),this.navigateTo(t.pathname+t.search))}),window.addEventListener("popstate",()=>{this.sendRelocate(window.location.pathname+window.location.search)}))}navigateTo(e){if(!this.isConnected){console.warn("PyHTML: Navigation blocked - Offline"),this.statusOverlay&&(this.statusOverlay.style.backgroundColor="rgba(200, 0, 0, 0.9)",this.statusOverlay.textContent="Cannot navigate - Offline",setTimeout(()=>{this.handleStatusChange(this.isConnected),this.statusOverlay&&(this.statusOverlay.style.backgroundColor="rgba(0, 0, 0, 0.8)")},1500));return}history.pushState({},"",e),this.sendRelocate(e)}sendRelocate(e){let t={type:"relocate",path:e};this.transport.send(t)}sendEvent(e,t){let n={type:"event",handler:e,path:window.location.pathname+window.location.search,data:t};this.transport.send(n)}handleMessage(e){switch(e.type){case"update":e.html&&this.updater.update(e.html);break;case"reload":console.log("PyHTML: Reloading..."),window.location.reload();break;case"error":console.error("PyHTML: Server error:",e.error);break;case"console":if(e.lines){let t="PyHTML Server:",n=e.lines;e.level==="error"?console.error(t,...n):e.level==="warn"?console.warn(t,...n):console.log(t,...n)}break;default:console.warn("PyHTML: Unknown message type",e)}}getTransport(){return this.transport.getActiveTransport()}disconnect(){this.transport.disconnect()}},Ue=new ue;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>Ue.init()):Ue.init();return Ze($t);})();
