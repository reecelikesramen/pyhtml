/* PyHTML Client v0.0.1 - https://github.com/reecelikesramen/pyhtml */
"use strict";var PyHTML=(()=>{var ne=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var ge=Object.getOwnPropertyNames;var ve=Object.prototype.hasOwnProperty;var me=(s,n)=>{for(var e in n)ne(s,e,{get:n[e],enumerable:!0})},Te=(s,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of ge(n))!ve.call(s,r)&&r!==e&&ne(s,r,{get:()=>n[r],enumerable:!(t=fe(n,r))||t.enumerable});return s};var ye=s=>Te(ne({},"__esModule",{value:!0}),s);var Ne={};me(Ne,{DOMUpdater:()=>B,HTTPTransport:()=>$,PyHTMLApp:()=>Q,TransportManager:()=>F,WebSocketTransport:()=>_,WebTransportTransport:()=>C,app:()=>ae});var L=class{constructor(){this.messageHandlers=[];this.connected=!1}onMessage(n){this.messageHandlers.push(n)}isConnected(){return this.connected}notifyHandlers(n){for(let e of this.messageHandlers)try{e(n)}catch(t){console.error("PyHTML: Error in message handler",t)}}};var C=class s extends L{constructor(e){super();this.name="WebTransport";this.transport=null;this.writer=null;this.encoder=new TextEncoder;this.decoder=new TextDecoder;this.shouldReconnect=!0;this.reconnectAttempts=0;this.maxReconnectDelay=5e3;this.url=e||this.getDefaultUrl()}getDefaultUrl(){return`https://${window.location.host}/_pyhtml/webtransport`}static isSupported(){return typeof WebTransport<"u"}async connect(){if(!s.isSupported())throw new Error("WebTransport not supported in this browser");try{let e={},t=window.PYHTML_CERT_HASH;t&&Array.isArray(t)&&(e.serverCertificateHashes=[{algorithm:"sha-256",value:new Uint8Array(t)}],console.log("PyHTML: Using explicit certificate hash for WebTransport")),this.transport=new WebTransport(this.url,e),await this.transport.ready,console.log("PyHTML: WebTransport ready"),this.connected=!0,this.reconnectAttempts=0,await this.sendInit(),this.startReading(),this.transport.closed.then(()=>{console.log("PyHTML: WebTransport closed"),this.handleDisconnect(),this.shouldReconnect&&this.scheduleReconnect()}).catch(r=>{console.error("PyHTML: WebTransport closed with error",r),this.handleDisconnect(),this.shouldReconnect&&this.scheduleReconnect()})}catch(e){throw this.handleDisconnect(),e}}async sendInit(){await this.send({type:"init",path:window.location.pathname+window.location.search})}async startReading(){this.transport&&(this.readBidirectionalStreams(),this.readDatagrams())}async readBidirectionalStreams(){if(!this.transport)return;let e=this.transport.incomingBidirectionalStreams.getReader();try{for(;;){let{value:t,done:r}=await e.read();if(r)break;this.handleStream(t)}}catch(t){this.connected&&console.error("PyHTML: WebTransport bidirectional stream read error",t)}}async readDatagrams(){if(!this.transport)return;let e=this.transport.datagrams.readable.getReader();try{for(;;){let{value:t,done:r}=await e.read();if(r)break;if(t){let a=this.decoder.decode(t);try{let d=JSON.parse(a);this.notifyHandlers(d)}catch(d){console.error("PyHTML: Error parsing WebTransport datagram",d)}}}}catch(t){this.connected&&console.error("PyHTML: WebTransport datagram read error",t)}}async handleStream(e){let t=e.readable.getReader(),r="";try{for(;;){let{value:a,done:d}=await t.read();if(d)break;a&&(r+=this.decoder.decode(a,{stream:!0}))}if(r)try{let a=JSON.parse(r);this.notifyHandlers(a)}catch(a){console.error("PyHTML: Error parsing WebTransport message",a,r)}}catch(a){console.error("PyHTML: Stream read error",a)}}async send(e){if(!this.transport||!this.connected){console.warn("PyHTML: Cannot send message, WebTransport not connected");return}try{let t=await this.transport.createBidirectionalStream(),r=t.writable.getWriter(),a=this.encoder.encode(JSON.stringify(e));await r.write(a),await r.close(),this.handleStream(t)}catch(t){console.error("PyHTML: WebTransport send error",t)}}disconnect(){this.shouldReconnect=!1,this.transport&&(this.transport.close(),this.transport=null),this.writer=null,this.connected=!1}handleDisconnect(){this.connected=!1,this.transport=null,this.writer=null}scheduleReconnect(){let e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);console.log(`PyHTML: WebTransport reconnecting in ${e}ms...`),setTimeout(()=>{this.reconnectAttempts++,this.connect().catch(t=>{console.warn("PyHTML: WebTransport reconnect failed",t)})},e)}};var _=class extends L{constructor(e){super();this.name="WebSocket";this.socket=null;this.reconnectAttempts=0;this.maxReconnectDelay=5e3;this.shouldReconnect=!0;this.url=e||this.getDefaultUrl()}getDefaultUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_pyhtml/ws`}connect(){return new Promise((e,t)=>{try{this.socket=new WebSocket(this.url),this.socket.onopen=()=>{console.log("PyHTML: WebSocket connected"),this.connected=!0,this.reconnectAttempts=0,e()},this.socket.onmessage=r=>{try{let a=JSON.parse(r.data);this.notifyHandlers(a)}catch(a){console.error("PyHTML: Error parsing WebSocket message",a)}},this.socket.onclose=()=>{console.log("PyHTML: WebSocket disconnected"),this.connected=!1,this.shouldReconnect&&this.scheduleReconnect()},this.socket.onerror=r=>{console.error("PyHTML: WebSocket error",r),this.connected||t(new Error("WebSocket connection failed"))}}catch(r){t(r)}})}send(e){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(JSON.stringify(e)):console.warn("PyHTML: Cannot send message, WebSocket not open")}disconnect(){this.shouldReconnect=!1,this.socket&&(this.socket.close(),this.socket=null),this.connected=!1}scheduleReconnect(){let e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);console.log(`PyHTML: Reconnecting in ${e}ms...`),setTimeout(()=>{this.reconnectAttempts++,this.connect().catch(()=>{})},e)}};var $=class extends L{constructor(e){super();this.name="HTTP";this.polling=!1;this.pollAbortController=null;this.sessionId=null;this.baseUrl=e||`${window.location.origin}/_pyhtml`}async connect(){try{let e=await fetch(`${this.baseUrl}/session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:window.location.pathname+window.location.search})});if(!e.ok)throw new Error(`HTTP session init failed: ${e.status}`);let t=await e.json();this.sessionId=t.sessionId,console.log("PyHTML: HTTP transport connected"),this.connected=!0,this.startPolling()}catch(e){throw console.error("PyHTML: HTTP transport connection failed",e),e}}async startPolling(){if(!this.polling)for(this.polling=!0;this.polling&&this.connected;)try{this.pollAbortController=new AbortController;let e=await fetch(`${this.baseUrl}/poll?session=${this.sessionId}`,{method:"GET",signal:this.pollAbortController.signal,headers:{Accept:"application/json"}});if(!e.ok){if(e.status===404){console.warn("PyHTML: HTTP session expired, reconnecting..."),this.connected=!1,await this.connect();return}throw new Error(`Poll failed: ${e.status}`)}let t=await e.json();for(let r of t)this.notifyHandlers(r)}catch(e){if(e instanceof Error&&e.name==="AbortError")break;console.error("PyHTML: HTTP poll error",e),await this.sleep(1e3)}}async send(e){if(!this.connected||!this.sessionId){console.warn("PyHTML: Cannot send message, HTTP transport not connected");return}try{let t=await fetch(`${this.baseUrl}/event`,{method:"POST",headers:{"Content-Type":"application/json","X-PyHTML-Session":this.sessionId},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Event send failed: ${t.status}`);let r=await t.json();this.notifyHandlers(r)}catch(t){console.error("PyHTML: HTTP send error",t)}}disconnect(){this.polling=!1,this.connected=!1,this.pollAbortController&&(this.pollAbortController.abort(),this.pollAbortController=null),this.sessionId=null}sleep(e){return new Promise(t=>setTimeout(t,e))}};var be={enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},F=class{constructor(n={}){this.transport=null;this.messageHandlers=[];this.config={...be,...n}}async connect(){let n=this.getTransportPriority();for(let e of n)try{console.log(`PyHTML: Trying ${e.name}...`),this.transport=new e;for(let t of this.messageHandlers)this.transport.onMessage(t);await this.transport.connect(),console.log(`PyHTML: Connected via ${this.transport.name}`);return}catch(t){console.warn(`PyHTML: ${e.name} failed, trying next...`,t),this.transport=null}throw new Error("PyHTML: All transports failed")}getTransportPriority(){let n=[];return this.config.enableWebTransport&&C.isSupported()&&window.location.protocol==="https:"&&n.push(C),this.config.enableWebSocket&&typeof WebSocket<"u"&&n.push(_),this.config.enableHTTP&&n.push($),n}send(n){this.transport?this.transport.send(n):console.warn("PyHTML: No active transport")}onMessage(n){this.messageHandlers.push(n),this.transport&&this.transport.onMessage(n)}disconnect(){this.transport&&(this.transport.disconnect(),this.transport=null)}getActiveTransport(){return this.transport?.name||null}isConnected(){return this.transport?.isConnected()||!1}};var ce=11;function we(s,n){var e=n.attributes,t,r,a,d,b;if(!(n.nodeType===ce||s.nodeType===ce)){for(var k=e.length-1;k>=0;k--)t=e[k],r=t.name,a=t.namespaceURI,d=t.value,a?(r=t.localName||r,b=s.getAttributeNS(a,r),b!==d&&(t.prefix==="xmlns"&&(r=t.name),s.setAttributeNS(a,r,d))):(b=s.getAttribute(r),b!==d&&s.setAttribute(r,d));for(var P=s.attributes,T=P.length-1;T>=0;T--)t=P[T],r=t.name,a=t.namespaceURI,a?(r=t.localName||r,n.hasAttributeNS(a,r)||s.removeAttributeNS(a,r)):n.hasAttribute(r)||s.removeAttribute(r)}}var q,Me="http://www.w3.org/1999/xhtml",v=typeof document>"u"?void 0:document,Pe=!!v&&"content"in v.createElement("template"),Se=!!v&&v.createRange&&"createContextualFragment"in v.createRange();function He(s){var n=v.createElement("template");return n.innerHTML=s,n.content.childNodes[0]}function Ae(s){q||(q=v.createRange(),q.selectNode(v.body));var n=q.createContextualFragment(s);return n.childNodes[0]}function Le(s){var n=v.createElement("body");return n.innerHTML=s,n.childNodes[0]}function xe(s){return s=s.trim(),Pe?He(s):Se?Ae(s):Le(s)}function Y(s,n){var e=s.nodeName,t=n.nodeName,r,a;return e===t?!0:(r=e.charCodeAt(0),a=t.charCodeAt(0),r<=90&&a>=97?e===t.toUpperCase():a<=90&&r>=97?t===e.toUpperCase():!1)}function ke(s,n){return!n||n===Me?v.createElement(s):v.createElementNS(n,s)}function Ee(s,n){for(var e=s.firstChild;e;){var t=e.nextSibling;n.appendChild(e),e=t}return n}function re(s,n,e){s[e]!==n[e]&&(s[e]=n[e],s[e]?s.setAttribute(e,""):s.removeAttribute(e))}var le={OPTION:function(s,n){var e=s.parentNode;if(e){var t=e.nodeName.toUpperCase();t==="OPTGROUP"&&(e=e.parentNode,t=e&&e.nodeName.toUpperCase()),t==="SELECT"&&!e.hasAttribute("multiple")&&(s.hasAttribute("selected")&&!n.selected&&(s.setAttribute("selected","selected"),s.removeAttribute("selected")),e.selectedIndex=-1)}re(s,n,"selected")},INPUT:function(s,n){re(s,n,"checked"),re(s,n,"disabled"),s.value!==n.value&&(s.value=n.value),n.hasAttribute("value")||s.removeAttribute("value")},TEXTAREA:function(s,n){var e=n.value;s.value!==e&&(s.value=e);var t=s.firstChild;if(t){var r=t.nodeValue;if(r==e||!e&&r==s.placeholder)return;t.nodeValue=e}},SELECT:function(s,n){if(!n.hasAttribute("multiple")){for(var e=-1,t=0,r=s.firstChild,a,d;r;)if(d=r.nodeName&&r.nodeName.toUpperCase(),d==="OPTGROUP")a=r,r=a.firstChild,r||(r=a.nextSibling,a=null);else{if(d==="OPTION"){if(r.hasAttribute("selected")){e=t;break}t++}r=r.nextSibling,!r&&a&&(r=a.nextSibling,a=null)}s.selectedIndex=e}}},z=1,de=11,pe=3,he=8;function x(){}function Re(s){if(s)return s.getAttribute&&s.getAttribute("id")||s.id}function Ce(s){return function(e,t,r){if(r||(r={}),typeof t=="string")if(e.nodeName==="#document"||e.nodeName==="HTML"||e.nodeName==="BODY"){var a=t;t=v.createElement("html"),t.innerHTML=a}else t=xe(t);else t.nodeType===de&&(t=t.firstElementChild);var d=r.getNodeKey||Re,b=r.onBeforeNodeAdded||x,k=r.onNodeAdded||x,P=r.onBeforeElUpdated||x,T=r.onElUpdated||x,m=r.onBeforeNodeDiscarded||x,w=r.onNodeDiscarded||x,E=r.onBeforeElChildrenUpdated||x,W=r.skipFromChildren||x,V=r.addChild||function(o,i){return o.appendChild(i)},D=r.childrenOnly===!0,S=Object.create(null),y=[];function u(o){y.push(o)}function h(o,i){if(o.nodeType===z)for(var p=o.firstChild;p;){var c=void 0;i&&(c=d(p))?u(c):(w(p),p.firstChild&&h(p,i)),p=p.nextSibling}}function R(o,i,p){m(o)!==!1&&(i&&i.removeChild(o),w(o),h(o,p))}function N(o){if(o.nodeType===z||o.nodeType===de)for(var i=o.firstChild;i;){var p=d(i);p&&(S[p]=i),N(i),i=i.nextSibling}}N(e);function f(o){k(o);for(var i=o.firstChild;i;){var p=i.nextSibling,c=d(i);if(c){var l=S[c];l&&Y(i,l)?(i.parentNode.replaceChild(l,i),U(l,i)):f(i)}else f(i);i=p}}function j(o,i,p){for(;i;){var c=i.nextSibling;(p=d(i))?u(p):R(i,o,!0),i=c}}function U(o,i,p){var c=d(i);if(c&&delete S[c],!p){var l=P(o,i);if(l===!1||(l instanceof HTMLElement&&(o=l,N(o)),s(o,i),T(o),E(o,i)===!1))return}o.nodeName!=="TEXTAREA"?J(o,i):le.TEXTAREA(o,i)}function J(o,i){var p=W(o,i),c=i.firstChild,l=o.firstChild,O,M,I,G,H;e:for(;c;){for(G=c.nextSibling,O=d(c);!p&&l;){if(I=l.nextSibling,c.isSameNode&&c.isSameNode(l)){c=G,l=I;continue e}M=d(l);var K=l.nodeType,A=void 0;if(K===c.nodeType&&(K===z?(O?O!==M&&((H=S[O])?I===H?A=!1:(o.insertBefore(H,l),M?u(M):R(l,o,!0),l=H,M=d(l)):A=!1):M&&(A=!1),A=A!==!1&&Y(l,c),A&&U(l,c)):(K===pe||K==he)&&(A=!0,l.nodeValue!==c.nodeValue&&(l.nodeValue=c.nodeValue))),A){c=G,l=I;continue e}M?u(M):R(l,o,!0),l=I}if(O&&(H=S[O])&&Y(H,c))p||V(o,H),U(H,c);else{var te=b(c);te!==!1&&(te&&(c=te),c.actualize&&(c=c.actualize(o.ownerDocument||v)),V(o,c),f(c))}c=G,l=I}j(o,l,M);var ie=le[o.nodeName];ie&&ie(o,i)}var g=e,X=g.nodeType,oe=t.nodeType;if(!D){if(X===z)oe===z?Y(e,t)||(w(e),g=Ee(e,ke(t.nodeName,t.namespaceURI))):g=t;else if(X===pe||X===he){if(oe===X)return g.nodeValue!==t.nodeValue&&(g.nodeValue=t.nodeValue),g;g=t}}if(g===t)w(e);else{if(t.isSameNode&&t.isSameNode(g))return;if(U(g,t,D),y)for(var Z=0,ue=y.length;Z<ue;Z++){var ee=S[y[Z]];ee&&R(ee,ee.parentNode,!1)}}return!D&&g!==e&&e.parentNode&&(g.actualize&&(g=g.actualize(e.ownerDocument||v)),e.parentNode.replaceChild(g,e)),g}}var We=Ce(we),se=We;var B=class{update(n){se?se(document.documentElement,n,{onBeforeElUpdated:(e,t)=>{if(e===document.activeElement&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA")){let r=t.getAttribute("value")||"",a=e.value||"";(a.startsWith(r)||r.startsWith(a))&&(t.setAttribute("value",a),t.value=a,e.tagName==="TEXTAREA"&&(t.textContent=a))}return!0}}):(document.open(),document.write(n),document.close())}};var De={autoInit:!0,enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},Q=class{constructor(n={}){this.initialized=!1;this.siblingPaths=[];this.pathRegexes=[];this.config={...De,...n},this.transport=new F(this.config),this.updater=new B}async init(){if(!this.initialized){this.initialized=!0,this.transport.onMessage(n=>this.handleMessage(n));try{await this.transport.connect()}catch(n){console.error("PyHTML: Failed to connect:",n)}this.loadSPAMetadata(),this.setupSPANavigation(),this.setupEventInterceptors(),console.log(`PyHTML: Initialized (transport: ${this.transport.getActiveTransport()}, spa_paths: ${this.siblingPaths.length})`)}}loadSPAMetadata(){let n=document.getElementById("_pyhtml_spa_meta");if(n)try{let e=JSON.parse(n.textContent||"{}");this.siblingPaths=e.sibling_paths||[],this.pathRegexes=this.siblingPaths.map(t=>this.patternToRegex(t))}catch(e){console.warn("PyHTML: Failed to parse SPA metadata",e)}}patternToRegex(n){let e=n.replace(/[.+?^${}()|[\]\\]/g,"\\$&");return e=e.replace(/:(\w+)(:\w+)?/g,"([^/]+)"),e=e.replace(/\{(\w+)(:\w+)?\}/g,"([^/]+)"),new RegExp(`^${e}$`)}isSiblingPath(n){return this.pathRegexes.some(e=>e.test(n))}setupSPANavigation(){this.siblingPaths.length!==0&&(document.addEventListener("click",n=>{let e=n.target.closest("a[href]");e&&e.origin===window.location.origin&&this.isSiblingPath(e.pathname)&&(n.preventDefault(),this.navigateTo(e.pathname+e.search))}),window.addEventListener("popstate",()=>{this.sendRelocate(window.location.pathname+window.location.search)}))}navigateTo(n){history.pushState({},"",n),this.sendRelocate(n)}sendRelocate(n){let e={type:"relocate",path:n};this.transport.send(e)}setupEventInterceptors(){document.addEventListener("click",e=>{let t=e.target.closest("[data-on-click]");if(t){e.preventDefault();let r=t.getAttribute("data-on-click");r&&this.sendEvent(r,{type:"click",id:t.id,value:t.value,args:this.getArgs(t)})}}),document.addEventListener("submit",async e=>{let t=e.target.closest("[data-on-submit]");if(t){e.preventDefault();let r=t.getAttribute("data-on-submit");if(r){let a=t,d=new FormData(a),b={};d.forEach((T,m)=>{T instanceof File||(b[m]=T.toString())});let k=a.querySelectorAll('input[type="file"]'),P=[];k.forEach(T=>{let m=T,w=m.name;if(w&&m.files&&m.files.length>0){let E=m.files[0],W=m.getAttribute("max-size");if(W){let y=parseInt(W),u=W.toLowerCase();if(u.endsWith("kb")||u.endsWith("k")?y=parseInt(u)*1024:u.endsWith("mb")||u.endsWith("m")?y=parseInt(u)*1024*1024:(u.endsWith("gb")||u.endsWith("g"))&&(y=parseInt(u)*1024*1024*1024),E.size>y){let h=`File is too large. Max size is ${W}.`;alert(h),P.push(Promise.reject(h));return}}let V=m.accept,D=new FormData;D.append(w,E);let S=new Promise((y,u)=>{let h=new XMLHttpRequest;h.open("POST","/_pyhtml/upload");let R=document.querySelector('meta[name="pyhtml-upload-token"]');if(R){let f=R.getAttribute("content");f&&h.setRequestHeader("X-Upload-Token",f)}let N=0;h.upload.onprogress=f=>{if(f.lengthComputable){let j=Date.now();if(j-N>=100){N=j;let U=f.loaded/f.total,J=m.getAttribute("data-on-upload-progress");J&&this.sendEvent(J,{type:"upload-progress",id:m.id,progress:U,args:this.getArgs(m)})}}},h.onload=()=>{if(h.status>=200&&h.status<300)try{let f=JSON.parse(h.responseText);f[w]?(b[w]={_upload_id:f[w],name:E.name,type:E.type,size:E.size},y()):(console.error("PyHTML: Upload failed, no ID returned",f),u(new Error("No ID returned")))}catch(f){u(f)}else{let f=`Upload failed: ${h.status} ${h.statusText}`;console.error("PyHTML: Upload failed",h.status,h.responseText),alert(f),u(new Error(f))}},h.onerror=()=>u(h.statusText),h.send(D)});P.push(S)}}),console.log("PyHTML: Waiting for uploads...");try{await Promise.all(P),console.log("PyHTML: Uploads complete. Sending submit event.")}catch(T){console.error("PyHTML: Upload validation failed",T);return}this.sendEvent(r,{type:"submit",id:t.id,formData:b,args:this.getArgs(t)})}}});let n;document.addEventListener("input",e=>{let t=e.target.closest("[data-on-input]");t&&(clearTimeout(n),n=window.setTimeout(()=>{let r=t.getAttribute("data-on-input");r&&this.sendEvent(r,{type:"input",id:t.id,value:t.value,args:this.getArgs(t)})},150))}),document.addEventListener("change",e=>{let t=e.target.closest("[data-on-change]");if(t){let r=t.getAttribute("data-on-change");r&&this.sendEvent(r,{type:"change",id:t.id,value:t.value,checked:t.checked,args:this.getArgs(t)})}})}getArgs(n){let e={};if(n instanceof HTMLElement){for(let t in n.dataset)if(t.startsWith("arg"))try{e[t]=JSON.parse(n.dataset[t]||"null")}catch{console.warn("PyHTML: Failed to parse arg",t,n.dataset[t]),e[t]=n.dataset[t]}}return e}sendEvent(n,e){let t={type:"event",handler:n,path:window.location.pathname+window.location.search,data:e};this.transport.send(t)}handleMessage(n){switch(n.type){case"update":n.html&&this.updater.update(n.html);break;case"reload":console.log("PyHTML: Reloading..."),window.location.reload();break;case"error":console.error("PyHTML: Server error:",n.error);break;case"console":if(n.lines){let e="PyHTML Server:",t=n.lines;n.level==="error"?console.error(e,...t):n.level==="warn"?console.warn(e,...t):console.log(e,...t)}break;default:console.warn("PyHTML: Unknown message type",n)}}getTransport(){return this.transport.getActiveTransport()}disconnect(){this.transport.disconnect()}},ae=new Q;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>ae.init()):ae.init();return ye(Ne);})();
