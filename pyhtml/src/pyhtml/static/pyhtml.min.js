/* PyHTML Client v0.0.1 - https://github.com/reecelikesramen/pyhtml */
"use strict";var PyHTML=(()=>{var K=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var ve=Object.getOwnPropertyNames;var ge=Object.prototype.hasOwnProperty;var Te=(a,n)=>{for(var e in n)K(a,e,{get:n[e],enumerable:!0})},me=(a,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of ve(n))!ge.call(a,r)&&r!==e&&K(a,r,{get:()=>n[r],enumerable:!(t=fe(n,r))||t.enumerable});return a};var be=a=>me(K({},"__esModule",{value:!0}),a);var Ne={};Te(Ne,{DOMUpdater:()=>k,HTTPTransport:()=>A,PyHTMLApp:()=>F,TransportManager:()=>L,WebSocketTransport:()=>H,WebTransportTransport:()=>w,app:()=>Q});var m=class{constructor(){this.messageHandlers=[];this.connected=!1}onMessage(n){this.messageHandlers.push(n)}isConnected(){return this.connected}notifyHandlers(n){for(let e of this.messageHandlers)try{e(n)}catch(t){console.error("PyHTML: Error in message handler",t)}}};var w=class a extends m{constructor(e){super();this.name="WebTransport";this.transport=null;this.writer=null;this.encoder=new TextEncoder;this.decoder=new TextDecoder;this.url=e||this.getDefaultUrl()}getDefaultUrl(){return`https://${window.location.host}/_pyhtml/webtransport`}static isSupported(){return typeof WebTransport<"u"}async connect(){if(!a.isSupported())throw new Error("WebTransport not supported in this browser");try{let e={},t=window.PYHTML_CERT_HASH;t&&Array.isArray(t)&&(e.serverCertificateHashes=[{algorithm:"sha-256",value:new Uint8Array(t)}],console.log("PyHTML: Using explicit certificate hash for WebTransport")),this.transport=new WebTransport(this.url,e),await this.transport.ready,console.log("PyHTML: WebTransport ready"),this.connected=!0,this.startReading()}catch(e){throw this.handleDisconnect(),e}}async startReading(){if(!this.transport)return;let e=this.transport.incomingBidirectionalStreams.getReader();try{for(;;){let{value:t,done:r}=await e.read();if(r)break;this.handleStream(t)}}catch(t){this.connected&&(console.error("PyHTML: WebTransport read error",t),this.handleDisconnect())}}async handleStream(e){let t=e.readable.getReader();try{for(;;){let{value:r,done:c}=await t.read();if(c)break;if(r){let d=this.decoder.decode(r);try{let f=JSON.parse(d);this.notifyHandlers(f)}catch(f){console.error("PyHTML: Error parsing WebTransport message",f)}}}}catch(r){console.error("PyHTML: Stream read error",r)}}async send(e){if(!this.transport||!this.connected){console.warn("PyHTML: Cannot send message, WebTransport not connected");return}try{let t=await this.transport.createBidirectionalStream(),r=t.writable.getWriter(),c=this.encoder.encode(JSON.stringify(e));await r.write(c),await r.close(),this.handleStream(t)}catch(t){console.error("PyHTML: WebTransport send error",t)}}disconnect(){this.transport&&(this.transport.close(),this.transport=null),this.writer=null,this.connected=!1}handleDisconnect(){this.connected=!1,this.transport=null,this.writer=null}};var H=class extends m{constructor(e){super();this.name="WebSocket";this.socket=null;this.reconnectAttempts=0;this.maxReconnectDelay=5e3;this.shouldReconnect=!0;this.url=e||this.getDefaultUrl()}getDefaultUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_pyhtml/ws`}connect(){return new Promise((e,t)=>{try{this.socket=new WebSocket(this.url),this.socket.onopen=()=>{console.log("PyHTML: WebSocket connected"),this.connected=!0,this.reconnectAttempts=0,e()},this.socket.onmessage=r=>{try{let c=JSON.parse(r.data);this.notifyHandlers(c)}catch(c){console.error("PyHTML: Error parsing WebSocket message",c)}},this.socket.onclose=()=>{console.log("PyHTML: WebSocket disconnected"),this.connected=!1,this.shouldReconnect&&this.scheduleReconnect()},this.socket.onerror=r=>{console.error("PyHTML: WebSocket error",r),this.connected||t(new Error("WebSocket connection failed"))}}catch(r){t(r)}})}send(e){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(JSON.stringify(e)):console.warn("PyHTML: Cannot send message, WebSocket not open")}disconnect(){this.shouldReconnect=!1,this.socket&&(this.socket.close(),this.socket=null),this.connected=!1}scheduleReconnect(){let e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);console.log(`PyHTML: Reconnecting in ${e}ms...`),setTimeout(()=>{this.reconnectAttempts++,this.connect().catch(()=>{})},e)}};var A=class extends m{constructor(e){super();this.name="HTTP";this.polling=!1;this.pollAbortController=null;this.sessionId=null;this.baseUrl=e||`${window.location.origin}/_pyhtml`}async connect(){try{let e=await fetch(`${this.baseUrl}/session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:window.location.pathname+window.location.search})});if(!e.ok)throw new Error(`HTTP session init failed: ${e.status}`);let t=await e.json();this.sessionId=t.sessionId,console.log("PyHTML: HTTP transport connected"),this.connected=!0,this.startPolling()}catch(e){throw console.error("PyHTML: HTTP transport connection failed",e),e}}async startPolling(){if(!this.polling)for(this.polling=!0;this.polling&&this.connected;)try{this.pollAbortController=new AbortController;let e=await fetch(`${this.baseUrl}/poll?session=${this.sessionId}`,{method:"GET",signal:this.pollAbortController.signal,headers:{Accept:"application/json"}});if(!e.ok){if(e.status===404){console.warn("PyHTML: HTTP session expired, reconnecting..."),this.connected=!1,await this.connect();return}throw new Error(`Poll failed: ${e.status}`)}let t=await e.json();for(let r of t)this.notifyHandlers(r)}catch(e){if(e instanceof Error&&e.name==="AbortError")break;console.error("PyHTML: HTTP poll error",e),await this.sleep(1e3)}}async send(e){if(!this.connected||!this.sessionId){console.warn("PyHTML: Cannot send message, HTTP transport not connected");return}try{let t=await fetch(`${this.baseUrl}/event`,{method:"POST",headers:{"Content-Type":"application/json","X-PyHTML-Session":this.sessionId},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Event send failed: ${t.status}`);let r=await t.json();this.notifyHandlers(r)}catch(t){console.error("PyHTML: HTTP send error",t)}}disconnect(){this.polling=!1,this.connected=!1,this.pollAbortController&&(this.pollAbortController.abort(),this.pollAbortController=null),this.sessionId=null}sleep(e){return new Promise(t=>setTimeout(t,e))}};var ye={enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},L=class{constructor(n={}){this.transport=null;this.messageHandlers=[];this.config={...ye,...n}}async connect(){let n=this.getTransportPriority();for(let e of n)try{console.log(`PyHTML: Trying ${e.name}...`),this.transport=new e;for(let t of this.messageHandlers)this.transport.onMessage(t);await this.transport.connect(),console.log(`PyHTML: Connected via ${this.transport.name}`);return}catch(t){console.warn(`PyHTML: ${e.name} failed, trying next...`,t),this.transport=null}throw new Error("PyHTML: All transports failed")}getTransportPriority(){let n=[];return this.config.enableWebTransport&&w.isSupported()&&window.location.protocol==="https:"&&n.push(w),this.config.enableWebSocket&&typeof WebSocket<"u"&&n.push(H),this.config.enableHTTP&&n.push(A),n}send(n){this.transport?this.transport.send(n):console.warn("PyHTML: No active transport")}onMessage(n){this.messageHandlers.push(n),this.transport&&this.transport.onMessage(n)}disconnect(){this.transport&&(this.transport.disconnect(),this.transport=null)}getActiveTransport(){return this.transport?.name||null}isConnected(){return this.transport?.isConnected()||!1}};var re=11;function we(a,n){var e=n.attributes,t,r,c,d,f;if(!(n.nodeType===re||a.nodeType===re)){for(var y=e.length-1;y>=0;y--)t=e[y],r=t.name,c=t.namespaceURI,d=t.value,c?(r=t.localName||r,f=a.getAttributeNS(c,r),f!==d&&(t.prefix==="xmlns"&&(r=t.name),a.setAttributeNS(c,r,d))):(f=a.getAttribute(r),f!==d&&a.setAttribute(r,d));for(var E=a.attributes,x=E.length-1;x>=0;x--)t=E[x],r=t.name,c=t.namespaceURI,c?(r=t.localName||r,n.hasAttributeNS(c,r)||a.removeAttributeNS(c,r)):n.hasAttribute(r)||a.removeAttribute(r)}}var $,Me="http://www.w3.org/1999/xhtml",u=typeof document>"u"?void 0:document,Se=!!u&&"content"in u.createElement("template"),Pe=!!u&&u.createRange&&"createContextualFragment"in u.createRange();function He(a){var n=u.createElement("template");return n.innerHTML=a,n.content.childNodes[0]}function Ae(a){$||($=u.createRange(),$.selectNode(u.body));var n=$.createContextualFragment(a);return n.childNodes[0]}function Le(a){var n=u.createElement("body");return n.innerHTML=a,n.childNodes[0]}function ke(a){return a=a.trim(),Se?He(a):Pe?Ae(a):Le(a)}function B(a,n){var e=a.nodeName,t=n.nodeName,r,c;return e===t?!0:(r=e.charCodeAt(0),c=t.charCodeAt(0),r<=90&&c>=97?e===t.toUpperCase():c<=90&&r>=97?t===e.toUpperCase():!1)}function xe(a,n){return!n||n===Me?u.createElement(a):u.createElementNS(n,a)}function Ce(a,n){for(var e=a.firstChild;e;){var t=e.nextSibling;n.appendChild(e),e=t}return n}function Y(a,n,e){a[e]!==n[e]&&(a[e]=n[e],a[e]?a.setAttribute(e,""):a.removeAttribute(e))}var ae={OPTION:function(a,n){var e=a.parentNode;if(e){var t=e.nodeName.toUpperCase();t==="OPTGROUP"&&(e=e.parentNode,t=e&&e.nodeName.toUpperCase()),t==="SELECT"&&!e.hasAttribute("multiple")&&(a.hasAttribute("selected")&&!n.selected&&(a.setAttribute("selected","selected"),a.removeAttribute("selected")),e.selectedIndex=-1)}Y(a,n,"selected")},INPUT:function(a,n){Y(a,n,"checked"),Y(a,n,"disabled"),a.value!==n.value&&(a.value=n.value),n.hasAttribute("value")||a.removeAttribute("value")},TEXTAREA:function(a,n){var e=n.value;a.value!==e&&(a.value=e);var t=a.firstChild;if(t){var r=t.nodeValue;if(r==e||!e&&r==a.placeholder)return;t.nodeValue=e}},SELECT:function(a,n){if(!n.hasAttribute("multiple")){for(var e=-1,t=0,r=a.firstChild,c,d;r;)if(d=r.nodeName&&r.nodeName.toUpperCase(),d==="OPTGROUP")c=r,r=c.firstChild,r||(r=c.nextSibling,c=null);else{if(d==="OPTION"){if(r.hasAttribute("selected")){e=t;break}t++}r=r.nextSibling,!r&&c&&(r=c.nextSibling,c=null)}a.selectedIndex=e}}},C=1,se=11,ie=3,oe=8;function b(){}function Ee(a){if(a)return a.getAttribute&&a.getAttribute("id")||a.id}function De(a){return function(e,t,r){if(r||(r={}),typeof t=="string")if(e.nodeName==="#document"||e.nodeName==="HTML"||e.nodeName==="BODY"){var c=t;t=u.createElement("html"),t.innerHTML=c}else t=ke(t);else t.nodeType===se&&(t=t.firstElementChild);var d=r.getNodeKey||Ee,f=r.onBeforeNodeAdded||b,y=r.onNodeAdded||b,E=r.onBeforeElUpdated||b,x=r.onElUpdated||b,ce=r.onBeforeNodeDiscarded||b,D=r.onNodeDiscarded||b,le=r.onBeforeElChildrenUpdated||b,de=r.skipFromChildren||b,Z=r.addChild||function(s,i){return s.appendChild(i)},j=r.childrenOnly===!0,M=Object.create(null),U=[];function W(s){U.push(s)}function ee(s,i){if(s.nodeType===C)for(var p=s.firstChild;p;){var o=void 0;i&&(o=d(p))?W(o):(D(p),p.firstChild&&ee(p,i)),p=p.nextSibling}}function N(s,i,p){ce(s)!==!1&&(i&&i.removeChild(s),D(s),ee(s,p))}function V(s){if(s.nodeType===C||s.nodeType===se)for(var i=s.firstChild;i;){var p=d(i);p&&(M[p]=i),V(i),i=i.nextSibling}}V(e);function G(s){y(s);for(var i=s.firstChild;i;){var p=i.nextSibling,o=d(i);if(o){var l=M[o];l&&B(i,l)?(i.parentNode.replaceChild(l,i),O(l,i)):G(i)}else G(i);i=p}}function pe(s,i,p){for(;i;){var o=i.nextSibling;(p=d(i))?W(p):N(i,s,!0),i=o}}function O(s,i,p){var o=d(i);if(o&&delete M[o],!p){var l=E(s,i);if(l===!1||(l instanceof HTMLElement&&(s=l,V(s)),a(s,i),x(s),le(s,i)===!1))return}s.nodeName!=="TEXTAREA"?he(s,i):ae.TEXTAREA(s,i)}function he(s,i){var p=de(s,i),o=i.firstChild,l=s.firstChild,S,v,P,I,g;e:for(;o;){for(I=o.nextSibling,S=d(o);!p&&l;){if(P=l.nextSibling,o.isSameNode&&o.isSameNode(l)){o=I,l=P;continue e}v=d(l);var _=l.nodeType,T=void 0;if(_===o.nodeType&&(_===C?(S?S!==v&&((g=M[S])?P===g?T=!1:(s.insertBefore(g,l),v?W(v):N(l,s,!0),l=g,v=d(l)):T=!1):v&&(T=!1),T=T!==!1&&B(l,o),T&&O(l,o)):(_===ie||_==oe)&&(T=!0,l.nodeValue!==o.nodeValue&&(l.nodeValue=o.nodeValue))),T){o=I,l=P;continue e}v?W(v):N(l,s,!0),l=P}if(S&&(g=M[S])&&B(g,o))p||Z(s,g),O(g,o);else{var X=f(o);X!==!1&&(X&&(o=X),o.actualize&&(o=o.actualize(s.ownerDocument||u)),Z(s,o),G(o))}o=I,l=P}pe(s,l,v);var ne=ae[s.nodeName];ne&&ne(s,i)}var h=e,R=h.nodeType,te=t.nodeType;if(!j){if(R===C)te===C?B(e,t)||(D(e),h=Ce(e,xe(t.nodeName,t.namespaceURI))):h=t;else if(R===ie||R===oe){if(te===R)return h.nodeValue!==t.nodeValue&&(h.nodeValue=t.nodeValue),h;h=t}}if(h===t)D(e);else{if(t.isSameNode&&t.isSameNode(h))return;if(O(h,t,j),U)for(var z=0,ue=U.length;z<ue;z++){var J=M[U[z]];J&&N(J,J.parentNode,!1)}}return!j&&h!==e&&e.parentNode&&(h.actualize&&(h=h.actualize(e.ownerDocument||u)),e.parentNode.replaceChild(h,e)),h}}var Ue=De(we),q=Ue;var k=class{update(n){q?q(document.documentElement,n):(document.open(),document.write(n),document.close())}};var We={autoInit:!0,enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},F=class{constructor(n={}){this.initialized=!1;this.config={...We,...n},this.transport=new L(this.config),this.updater=new k}async init(){if(!this.initialized){this.initialized=!0,this.transport.onMessage(n=>this.handleMessage(n));try{await this.transport.connect()}catch(n){console.error("PyHTML: Failed to connect:",n)}this.setupEventInterceptors(),console.log(`PyHTML: Initialized (transport: ${this.transport.getActiveTransport()})`)}}setupEventInterceptors(){document.addEventListener("click",e=>{let t=e.target.closest("[data-on-click]");if(t){e.preventDefault();let r=t.getAttribute("data-on-click");r&&this.sendEvent(r,{type:"click",id:t.id,value:t.value})}}),document.addEventListener("submit",e=>{let t=e.target.closest("[data-on-submit]");if(t){e.preventDefault();let r=t.getAttribute("data-on-submit");if(r){let c=new FormData(t),d={};c.forEach((f,y)=>{d[y]=f.toString()}),this.sendEvent(r,{type:"submit",id:t.id,formData:d})}}});let n;document.addEventListener("input",e=>{let t=e.target.closest("[data-on-input]");t&&(clearTimeout(n),n=window.setTimeout(()=>{let r=t.getAttribute("data-on-input");r&&this.sendEvent(r,{type:"input",id:t.id,value:t.value})},150))}),document.addEventListener("change",e=>{let t=e.target.closest("[data-on-change]");if(t){let r=t.getAttribute("data-on-change");r&&this.sendEvent(r,{type:"change",id:t.id,value:t.value,checked:t.checked})}})}sendEvent(n,e){let t={type:"event",handler:n,path:window.location.pathname+window.location.search,data:e};this.transport.send(t)}handleMessage(n){switch(n.type){case"update":n.html&&this.updater.update(n.html);break;case"reload":console.log("PyHTML: Reloading..."),window.location.reload();break;case"error":console.error("PyHTML: Server error:",n.error);break;default:console.warn("PyHTML: Unknown message type",n)}}getTransport(){return this.transport.getActiveTransport()}disconnect(){this.transport.disconnect()}},Q=new F;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>Q.init()):Q.init();return be(Ne);})();
