/* PyHTML Client v0.0.1 - https://github.com/reecelikesramen/pyhtml */
"use strict";var PyHTML=(()=>{var ne=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var ge=Object.getOwnPropertyNames;var ve=Object.prototype.hasOwnProperty;var Te=(s,n)=>{for(var e in n)ne(s,e,{get:n[e],enumerable:!0})},me=(s,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of ge(n))!ve.call(s,r)&&r!==e&&ne(s,r,{get:()=>n[r],enumerable:!(t=fe(n,r))||t.enumerable});return s};var ye=s=>me(ne({},"__esModule",{value:!0}),s);var Ne={};Te(Ne,{DOMUpdater:()=>j,HTTPTransport:()=>$,PyHTMLApp:()=>Q,TransportManager:()=>F,WebSocketTransport:()=>_,WebTransportTransport:()=>R,app:()=>ae});var x=class{constructor(){this.messageHandlers=[];this.connected=!1}onMessage(n){this.messageHandlers.push(n)}isConnected(){return this.connected}notifyHandlers(n){for(let e of this.messageHandlers)try{e(n)}catch(t){console.error("PyHTML: Error in message handler",t)}}};var R=class s extends x{constructor(e){super();this.name="WebTransport";this.transport=null;this.writer=null;this.encoder=new TextEncoder;this.decoder=new TextDecoder;this.url=e||this.getDefaultUrl()}getDefaultUrl(){return`https://${window.location.host}/_pyhtml/webtransport`}static isSupported(){return typeof WebTransport<"u"}async connect(){if(!s.isSupported())throw new Error("WebTransport not supported in this browser");try{let e={},t=window.PYHTML_CERT_HASH;t&&Array.isArray(t)&&(e.serverCertificateHashes=[{algorithm:"sha-256",value:new Uint8Array(t)}],console.log("PyHTML: Using explicit certificate hash for WebTransport")),this.transport=new WebTransport(this.url,e),await this.transport.ready,console.log("PyHTML: WebTransport ready"),this.connected=!0,this.startReading()}catch(e){throw this.handleDisconnect(),e}}async startReading(){if(!this.transport)return;let e=this.transport.incomingBidirectionalStreams.getReader();try{for(;;){let{value:t,done:r}=await e.read();if(r)break;this.handleStream(t)}}catch(t){this.connected&&(console.error("PyHTML: WebTransport read error",t),this.handleDisconnect())}}async handleStream(e){let t=e.readable.getReader();try{for(;;){let{value:r,done:o}=await t.read();if(o)break;if(r){let d=this.decoder.decode(r);try{let v=JSON.parse(d);this.notifyHandlers(v)}catch(v){console.error("PyHTML: Error parsing WebTransport message",v)}}}}catch(r){console.error("PyHTML: Stream read error",r)}}async send(e){if(!this.transport||!this.connected){console.warn("PyHTML: Cannot send message, WebTransport not connected");return}try{let t=await this.transport.createBidirectionalStream(),r=t.writable.getWriter(),o=this.encoder.encode(JSON.stringify(e));await r.write(o),await r.close(),this.handleStream(t)}catch(t){console.error("PyHTML: WebTransport send error",t)}}disconnect(){this.transport&&(this.transport.close(),this.transport=null),this.writer=null,this.connected=!1}handleDisconnect(){this.connected=!1,this.transport=null,this.writer=null}};var _=class extends x{constructor(e){super();this.name="WebSocket";this.socket=null;this.reconnectAttempts=0;this.maxReconnectDelay=5e3;this.shouldReconnect=!0;this.url=e||this.getDefaultUrl()}getDefaultUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_pyhtml/ws`}connect(){return new Promise((e,t)=>{try{this.socket=new WebSocket(this.url),this.socket.onopen=()=>{console.log("PyHTML: WebSocket connected"),this.connected=!0,this.reconnectAttempts=0,e()},this.socket.onmessage=r=>{try{let o=JSON.parse(r.data);this.notifyHandlers(o)}catch(o){console.error("PyHTML: Error parsing WebSocket message",o)}},this.socket.onclose=()=>{console.log("PyHTML: WebSocket disconnected"),this.connected=!1,this.shouldReconnect&&this.scheduleReconnect()},this.socket.onerror=r=>{console.error("PyHTML: WebSocket error",r),this.connected||t(new Error("WebSocket connection failed"))}}catch(r){t(r)}})}send(e){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(JSON.stringify(e)):console.warn("PyHTML: Cannot send message, WebSocket not open")}disconnect(){this.shouldReconnect=!1,this.socket&&(this.socket.close(),this.socket=null),this.connected=!1}scheduleReconnect(){let e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);console.log(`PyHTML: Reconnecting in ${e}ms...`),setTimeout(()=>{this.reconnectAttempts++,this.connect().catch(()=>{})},e)}};var $=class extends x{constructor(e){super();this.name="HTTP";this.polling=!1;this.pollAbortController=null;this.sessionId=null;this.baseUrl=e||`${window.location.origin}/_pyhtml`}async connect(){try{let e=await fetch(`${this.baseUrl}/session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:window.location.pathname+window.location.search})});if(!e.ok)throw new Error(`HTTP session init failed: ${e.status}`);let t=await e.json();this.sessionId=t.sessionId,console.log("PyHTML: HTTP transport connected"),this.connected=!0,this.startPolling()}catch(e){throw console.error("PyHTML: HTTP transport connection failed",e),e}}async startPolling(){if(!this.polling)for(this.polling=!0;this.polling&&this.connected;)try{this.pollAbortController=new AbortController;let e=await fetch(`${this.baseUrl}/poll?session=${this.sessionId}`,{method:"GET",signal:this.pollAbortController.signal,headers:{Accept:"application/json"}});if(!e.ok){if(e.status===404){console.warn("PyHTML: HTTP session expired, reconnecting..."),this.connected=!1,await this.connect();return}throw new Error(`Poll failed: ${e.status}`)}let t=await e.json();for(let r of t)this.notifyHandlers(r)}catch(e){if(e instanceof Error&&e.name==="AbortError")break;console.error("PyHTML: HTTP poll error",e),await this.sleep(1e3)}}async send(e){if(!this.connected||!this.sessionId){console.warn("PyHTML: Cannot send message, HTTP transport not connected");return}try{let t=await fetch(`${this.baseUrl}/event`,{method:"POST",headers:{"Content-Type":"application/json","X-PyHTML-Session":this.sessionId},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Event send failed: ${t.status}`);let r=await t.json();this.notifyHandlers(r)}catch(t){console.error("PyHTML: HTTP send error",t)}}disconnect(){this.polling=!1,this.connected=!1,this.pollAbortController&&(this.pollAbortController.abort(),this.pollAbortController=null),this.sessionId=null}sleep(e){return new Promise(t=>setTimeout(t,e))}};var be={enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},F=class{constructor(n={}){this.transport=null;this.messageHandlers=[];this.config={...be,...n}}async connect(){let n=this.getTransportPriority();for(let e of n)try{console.log(`PyHTML: Trying ${e.name}...`),this.transport=new e;for(let t of this.messageHandlers)this.transport.onMessage(t);await this.transport.connect(),console.log(`PyHTML: Connected via ${this.transport.name}`);return}catch(t){console.warn(`PyHTML: ${e.name} failed, trying next...`,t),this.transport=null}throw new Error("PyHTML: All transports failed")}getTransportPriority(){let n=[];return this.config.enableWebTransport&&R.isSupported()&&window.location.protocol==="https:"&&n.push(R),this.config.enableWebSocket&&typeof WebSocket<"u"&&n.push(_),this.config.enableHTTP&&n.push($),n}send(n){this.transport?this.transport.send(n):console.warn("PyHTML: No active transport")}onMessage(n){this.messageHandlers.push(n),this.transport&&this.transport.onMessage(n)}disconnect(){this.transport&&(this.transport.disconnect(),this.transport=null)}getActiveTransport(){return this.transport?.name||null}isConnected(){return this.transport?.isConnected()||!1}};var le=11;function we(s,n){var e=n.attributes,t,r,o,d,v;if(!(n.nodeType===le||s.nodeType===le)){for(var k=e.length-1;k>=0;k--)t=e[k],r=t.name,o=t.namespaceURI,d=t.value,o?(r=t.localName||r,v=s.getAttributeNS(o,r),v!==d&&(t.prefix==="xmlns"&&(r=t.name),s.setAttributeNS(o,r,d))):(v=s.getAttribute(r),v!==d&&s.setAttribute(r,d));for(var P=s.attributes,y=P.length-1;y>=0;y--)t=P[y],r=t.name,o=t.namespaceURI,o?(r=t.localName||r,n.hasAttributeNS(o,r)||s.removeAttributeNS(o,r)):n.hasAttribute(r)||s.removeAttribute(r)}}var q,Me="http://www.w3.org/1999/xhtml",T=typeof document>"u"?void 0:document,Pe=!!T&&"content"in T.createElement("template"),Se=!!T&&T.createRange&&"createContextualFragment"in T.createRange();function He(s){var n=T.createElement("template");return n.innerHTML=s,n.content.childNodes[0]}function Ae(s){q||(q=T.createRange(),q.selectNode(T.body));var n=q.createContextualFragment(s);return n.childNodes[0]}function xe(s){var n=T.createElement("body");return n.innerHTML=s,n.childNodes[0]}function Le(s){return s=s.trim(),Pe?He(s):Se?Ae(s):xe(s)}function Y(s,n){var e=s.nodeName,t=n.nodeName,r,o;return e===t?!0:(r=e.charCodeAt(0),o=t.charCodeAt(0),r<=90&&o>=97?e===t.toUpperCase():o<=90&&r>=97?t===e.toUpperCase():!1)}function ke(s,n){return!n||n===Me?T.createElement(s):T.createElementNS(n,s)}function Ee(s,n){for(var e=s.firstChild;e;){var t=e.nextSibling;n.appendChild(e),e=t}return n}function re(s,n,e){s[e]!==n[e]&&(s[e]=n[e],s[e]?s.setAttribute(e,""):s.removeAttribute(e))}var ce={OPTION:function(s,n){var e=s.parentNode;if(e){var t=e.nodeName.toUpperCase();t==="OPTGROUP"&&(e=e.parentNode,t=e&&e.nodeName.toUpperCase()),t==="SELECT"&&!e.hasAttribute("multiple")&&(s.hasAttribute("selected")&&!n.selected&&(s.setAttribute("selected","selected"),s.removeAttribute("selected")),e.selectedIndex=-1)}re(s,n,"selected")},INPUT:function(s,n){re(s,n,"checked"),re(s,n,"disabled"),s.value!==n.value&&(s.value=n.value),n.hasAttribute("value")||s.removeAttribute("value")},TEXTAREA:function(s,n){var e=n.value;s.value!==e&&(s.value=e);var t=s.firstChild;if(t){var r=t.nodeValue;if(r==e||!e&&r==s.placeholder)return;t.nodeValue=e}},SELECT:function(s,n){if(!n.hasAttribute("multiple")){for(var e=-1,t=0,r=s.firstChild,o,d;r;)if(d=r.nodeName&&r.nodeName.toUpperCase(),d==="OPTGROUP")o=r,r=o.firstChild,r||(r=o.nextSibling,o=null);else{if(d==="OPTION"){if(r.hasAttribute("selected")){e=t;break}t++}r=r.nextSibling,!r&&o&&(r=o.nextSibling,o=null)}s.selectedIndex=e}}},B=1,de=11,pe=3,he=8;function L(){}function Ce(s){if(s)return s.getAttribute&&s.getAttribute("id")||s.id}function Re(s){return function(e,t,r){if(r||(r={}),typeof t=="string")if(e.nodeName==="#document"||e.nodeName==="HTML"||e.nodeName==="BODY"){var o=t;t=T.createElement("html"),t.innerHTML=o}else t=Le(t);else t.nodeType===de&&(t=t.firstElementChild);var d=r.getNodeKey||Ce,v=r.onBeforeNodeAdded||L,k=r.onNodeAdded||L,P=r.onBeforeElUpdated||L,y=r.onElUpdated||L,m=r.onBeforeNodeDiscarded||L,w=r.onNodeDiscarded||L,E=r.onBeforeElChildrenUpdated||L,D=r.skipFromChildren||L,z=r.addChild||function(a,i){return a.appendChild(i)},W=r.childrenOnly===!0,S=Object.create(null),b=[];function u(a){b.push(a)}function h(a,i){if(a.nodeType===B)for(var p=a.firstChild;p;){var l=void 0;i&&(l=d(p))?u(l):(w(p),p.firstChild&&h(p,i)),p=p.nextSibling}}function C(a,i,p){m(a)!==!1&&(i&&i.removeChild(a),w(a),h(a,p))}function N(a){if(a.nodeType===B||a.nodeType===de)for(var i=a.firstChild;i;){var p=d(i);p&&(S[p]=i),N(i),i=i.nextSibling}}N(e);function f(a){k(a);for(var i=a.firstChild;i;){var p=i.nextSibling,l=d(i);if(l){var c=S[l];c&&Y(i,c)?(i.parentNode.replaceChild(c,i),U(c,i)):f(i)}else f(i);i=p}}function V(a,i,p){for(;i;){var l=i.nextSibling;(p=d(i))?u(p):C(i,a,!0),i=l}}function U(a,i,p){var l=d(i);if(l&&delete S[l],!p){var c=P(a,i);if(c===!1||(c instanceof HTMLElement&&(a=c,N(a)),s(a,i),y(a),E(a,i)===!1))return}a.nodeName!=="TEXTAREA"?X(a,i):ce.TEXTAREA(a,i)}function X(a,i){var p=D(a,i),l=i.firstChild,c=a.firstChild,O,M,I,J,H;e:for(;l;){for(J=l.nextSibling,O=d(l);!p&&c;){if(I=c.nextSibling,l.isSameNode&&l.isSameNode(c)){l=J,c=I;continue e}M=d(c);var K=c.nodeType,A=void 0;if(K===l.nodeType&&(K===B?(O?O!==M&&((H=S[O])?I===H?A=!1:(a.insertBefore(H,c),M?u(M):C(c,a,!0),c=H,M=d(c)):A=!1):M&&(A=!1),A=A!==!1&&Y(c,l),A&&U(c,l)):(K===pe||K==he)&&(A=!0,c.nodeValue!==l.nodeValue&&(c.nodeValue=l.nodeValue))),A){l=J,c=I;continue e}M?u(M):C(c,a,!0),c=I}if(O&&(H=S[O])&&Y(H,l))p||z(a,H),U(H,l);else{var te=v(l);te!==!1&&(te&&(l=te),l.actualize&&(l=l.actualize(a.ownerDocument||T)),z(a,l),f(l))}l=J,c=I}V(a,c,M);var oe=ce[a.nodeName];oe&&oe(a,i)}var g=e,G=g.nodeType,ie=t.nodeType;if(!W){if(G===B)ie===B?Y(e,t)||(w(e),g=Ee(e,ke(t.nodeName,t.namespaceURI))):g=t;else if(G===pe||G===he){if(ie===G)return g.nodeValue!==t.nodeValue&&(g.nodeValue=t.nodeValue),g;g=t}}if(g===t)w(e);else{if(t.isSameNode&&t.isSameNode(g))return;if(U(g,t,W),b)for(var Z=0,ue=b.length;Z<ue;Z++){var ee=S[b[Z]];ee&&C(ee,ee.parentNode,!1)}}return!W&&g!==e&&e.parentNode&&(g.actualize&&(g=g.actualize(e.ownerDocument||T)),e.parentNode.replaceChild(g,e)),g}}var De=Re(we),se=De;var j=class{update(n){se?se(document.documentElement,n,{onBeforeElUpdated:(e,t)=>{if(e===document.activeElement&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA")){let r=t.getAttribute("value")||"",o=e.value||"";(o.startsWith(r)||r.startsWith(o))&&(t.setAttribute("value",o),t.value=o,e.tagName==="TEXTAREA"&&(t.textContent=o))}return!0}}):(document.open(),document.write(n),document.close())}};var We={autoInit:!0,enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},Q=class{constructor(n={}){this.initialized=!1;this.siblingPaths=[];this.pathRegexes=[];this.pjaxEnabled=!1;this.config={...We,...n},this.transport=new F(this.config),this.updater=new j}async init(){if(!this.initialized){this.initialized=!0,this.transport.onMessage(n=>this.handleMessage(n));try{await this.transport.connect()}catch(n){console.error("PyHTML: Failed to connect:",n)}this.loadSPAMetadata(),this.setupSPANavigation(),this.setupEventInterceptors(),console.log(`PyHTML: Initialized (transport: ${this.transport.getActiveTransport()}, spa_paths: ${this.siblingPaths.length}, pjax: ${this.pjaxEnabled})`)}}loadSPAMetadata(){let n=document.getElementById("_pyhtml_spa_meta");if(n)try{let e=JSON.parse(n.textContent||"{}");this.siblingPaths=e.sibling_paths||[],this.pjaxEnabled=!!e.enable_pjax,this.pathRegexes=this.siblingPaths.map(t=>this.patternToRegex(t))}catch(e){console.warn("PyHTML: Failed to parse SPA metadata",e)}}patternToRegex(n){let e=n.replace(/[.+?^${}()|[\]\\]/g,"\\$&");return e=e.replace(/:(\w+)(:\w+)?/g,"([^/]+)"),e=e.replace(/\{(\w+)(:\w+)?\}/g,"([^/]+)"),new RegExp(`^${e}$`)}isSiblingPath(n){return this.pathRegexes.some(e=>e.test(n))}setupSPANavigation(){this.siblingPaths.length===0&&!this.pjaxEnabled||(document.addEventListener("click",n=>{let e=n.target.closest("a[href]");if(!e||e.origin!==window.location.origin||e.hasAttribute("download")||e.target==="_blank")return;let t=!1;(this.pjaxEnabled||this.isSiblingPath(e.pathname))&&(t=!0),t&&(n.preventDefault(),this.navigateTo(e.pathname+e.search))}),window.addEventListener("popstate",()=>{this.sendRelocate(window.location.pathname+window.location.search)}))}navigateTo(n){history.pushState({},"",n),this.sendRelocate(n)}sendRelocate(n){let e={type:"relocate",path:n};this.transport.send(e)}setupEventInterceptors(){document.addEventListener("click",e=>{let t=e.target.closest("[data-on-click]");if(t){e.preventDefault();let r=t.getAttribute("data-on-click");r&&this.sendEvent(r,{type:"click",id:t.id,value:t.value,args:this.getArgs(t)})}}),document.addEventListener("submit",async e=>{let t=e.target.closest("[data-on-submit]");if(t){e.preventDefault();let r=t.getAttribute("data-on-submit");if(r){let o=t,d=new FormData(o),v={};d.forEach((y,m)=>{y instanceof File||(v[m]=y.toString())});let k=o.querySelectorAll('input[type="file"]'),P=[];k.forEach(y=>{let m=y,w=m.name;if(w&&m.files&&m.files.length>0){let E=m.files[0],D=m.getAttribute("max-size");if(D){let b=parseInt(D),u=D.toLowerCase();if(u.endsWith("kb")||u.endsWith("k")?b=parseInt(u)*1024:u.endsWith("mb")||u.endsWith("m")?b=parseInt(u)*1024*1024:(u.endsWith("gb")||u.endsWith("g"))&&(b=parseInt(u)*1024*1024*1024),E.size>b){let h=`File is too large. Max size is ${D}.`;alert(h),P.push(Promise.reject(h));return}}let z=m.accept,W=new FormData;W.append(w,E);let S=new Promise((b,u)=>{let h=new XMLHttpRequest;h.open("POST","/_pyhtml/upload");let C=document.querySelector('meta[name="pyhtml-upload-token"]');if(C){let f=C.getAttribute("content");f&&h.setRequestHeader("X-Upload-Token",f)}let N=0;h.upload.onprogress=f=>{if(f.lengthComputable){let V=Date.now();if(V-N>=100){N=V;let U=f.loaded/f.total,X=m.getAttribute("data-on-upload-progress");X&&this.sendEvent(X,{type:"upload-progress",id:m.id,progress:U,args:this.getArgs(m)})}}},h.onload=()=>{if(h.status>=200&&h.status<300)try{let f=JSON.parse(h.responseText);f[w]?(v[w]={_upload_id:f[w],name:E.name,type:E.type,size:E.size},b()):(console.error("PyHTML: Upload failed, no ID returned",f),u(new Error("No ID returned")))}catch(f){u(f)}else{let f=`Upload failed: ${h.status} ${h.statusText}`;console.error("PyHTML: Upload failed",h.status,h.responseText),alert(f),u(new Error(f))}},h.onerror=()=>u(h.statusText),h.send(W)});P.push(S)}}),console.log("PyHTML: Waiting for uploads...");try{await Promise.all(P),console.log("PyHTML: Uploads complete. Sending submit event.")}catch(y){console.error("PyHTML: Upload validation failed",y);return}this.sendEvent(r,{type:"submit",id:t.id,formData:v,args:this.getArgs(t)})}}});let n;document.addEventListener("input",e=>{let t=e.target.closest("[data-on-input]");t&&(clearTimeout(n),n=window.setTimeout(()=>{let r=t.getAttribute("data-on-input");r&&this.sendEvent(r,{type:"input",id:t.id,value:t.value,args:this.getArgs(t)})},150))}),document.addEventListener("change",e=>{let t=e.target.closest("[data-on-change]");if(t){let r=t.getAttribute("data-on-change");r&&this.sendEvent(r,{type:"change",id:t.id,value:t.value,checked:t.checked,args:this.getArgs(t)})}})}getArgs(n){let e={};if(n instanceof HTMLElement){for(let t in n.dataset)if(t.startsWith("arg"))try{e[t]=JSON.parse(n.dataset[t]||"null")}catch{console.warn("PyHTML: Failed to parse arg",t,n.dataset[t]),e[t]=n.dataset[t]}}return e}sendEvent(n,e){let t={type:"event",handler:n,path:window.location.pathname+window.location.search,data:e};this.transport.send(t)}handleMessage(n){switch(n.type){case"update":n.html&&this.updater.update(n.html);break;case"reload":console.log("PyHTML: Reloading..."),window.location.reload();break;case"error":console.error("PyHTML: Server error:",n.error);break;case"console":if(n.lines){let e="PyHTML Server:",t=n.lines;n.level==="error"?console.error(e,...t):n.level==="warn"?console.warn(e,...t):console.log(e,...t)}break;default:console.warn("PyHTML: Unknown message type",n)}}getTransport(){return this.transport.getActiveTransport()}disconnect(){this.transport.disconnect()}},ae=new Q;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>ae.init()):ae.init();return ye(Ne);})();
