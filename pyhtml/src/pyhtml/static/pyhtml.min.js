/* PyHTML Client v0.0.1 - https://github.com/reecelikesramen/pyhtml */
"use strict";var PyHTML=(()=>{var Z=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var ge=Object.getOwnPropertyNames;var ve=Object.prototype.hasOwnProperty;var Te=(a,n)=>{for(var e in n)Z(a,e,{get:n[e],enumerable:!0})},me=(a,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of ge(n))!ve.call(a,r)&&r!==e&&Z(a,r,{get:()=>n[r],enumerable:!(t=fe(n,r))||t.enumerable});return a};var ye=a=>me(Z({},"__esModule",{value:!0}),a);var Ue={};Te(Ue,{DOMUpdater:()=>D,HTTPTransport:()=>R,PyHTMLApp:()=>G,TransportManager:()=>N,WebSocketTransport:()=>C,WebTransportTransport:()=>x,app:()=>ne});var b=class{constructor(){this.messageHandlers=[];this.connected=!1}onMessage(n){this.messageHandlers.push(n)}isConnected(){return this.connected}notifyHandlers(n){for(let e of this.messageHandlers)try{e(n)}catch(t){console.error("PyHTML: Error in message handler",t)}}};var x=class a extends b{constructor(e){super();this.name="WebTransport";this.transport=null;this.writer=null;this.encoder=new TextEncoder;this.decoder=new TextDecoder;this.url=e||this.getDefaultUrl()}getDefaultUrl(){return`https://${window.location.host}/_pyhtml/webtransport`}static isSupported(){return typeof WebTransport<"u"}async connect(){if(!a.isSupported())throw new Error("WebTransport not supported in this browser");try{let e={},t=window.PYHTML_CERT_HASH;t&&Array.isArray(t)&&(e.serverCertificateHashes=[{algorithm:"sha-256",value:new Uint8Array(t)}],console.log("PyHTML: Using explicit certificate hash for WebTransport")),this.transport=new WebTransport(this.url,e),await this.transport.ready,console.log("PyHTML: WebTransport ready"),this.connected=!0,this.startReading()}catch(e){throw this.handleDisconnect(),e}}async startReading(){if(!this.transport)return;let e=this.transport.incomingBidirectionalStreams.getReader();try{for(;;){let{value:t,done:r}=await e.read();if(r)break;this.handleStream(t)}}catch(t){this.connected&&(console.error("PyHTML: WebTransport read error",t),this.handleDisconnect())}}async handleStream(e){let t=e.readable.getReader();try{for(;;){let{value:r,done:o}=await t.read();if(o)break;if(r){let d=this.decoder.decode(r);try{let u=JSON.parse(d);this.notifyHandlers(u)}catch(u){console.error("PyHTML: Error parsing WebTransport message",u)}}}}catch(r){console.error("PyHTML: Stream read error",r)}}async send(e){if(!this.transport||!this.connected){console.warn("PyHTML: Cannot send message, WebTransport not connected");return}try{let t=await this.transport.createBidirectionalStream(),r=t.writable.getWriter(),o=this.encoder.encode(JSON.stringify(e));await r.write(o),await r.close(),this.handleStream(t)}catch(t){console.error("PyHTML: WebTransport send error",t)}}disconnect(){this.transport&&(this.transport.close(),this.transport=null),this.writer=null,this.connected=!1}handleDisconnect(){this.connected=!1,this.transport=null,this.writer=null}};var C=class extends b{constructor(e){super();this.name="WebSocket";this.socket=null;this.reconnectAttempts=0;this.maxReconnectDelay=5e3;this.shouldReconnect=!0;this.url=e||this.getDefaultUrl()}getDefaultUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_pyhtml/ws`}connect(){return new Promise((e,t)=>{try{this.socket=new WebSocket(this.url),this.socket.onopen=()=>{console.log("PyHTML: WebSocket connected"),this.connected=!0,this.reconnectAttempts=0,e()},this.socket.onmessage=r=>{try{let o=JSON.parse(r.data);this.notifyHandlers(o)}catch(o){console.error("PyHTML: Error parsing WebSocket message",o)}},this.socket.onclose=()=>{console.log("PyHTML: WebSocket disconnected"),this.connected=!1,this.shouldReconnect&&this.scheduleReconnect()},this.socket.onerror=r=>{console.error("PyHTML: WebSocket error",r),this.connected||t(new Error("WebSocket connection failed"))}}catch(r){t(r)}})}send(e){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(JSON.stringify(e)):console.warn("PyHTML: Cannot send message, WebSocket not open")}disconnect(){this.shouldReconnect=!1,this.socket&&(this.socket.close(),this.socket=null),this.connected=!1}scheduleReconnect(){let e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);console.log(`PyHTML: Reconnecting in ${e}ms...`),setTimeout(()=>{this.reconnectAttempts++,this.connect().catch(()=>{})},e)}};var R=class extends b{constructor(e){super();this.name="HTTP";this.polling=!1;this.pollAbortController=null;this.sessionId=null;this.baseUrl=e||`${window.location.origin}/_pyhtml`}async connect(){try{let e=await fetch(`${this.baseUrl}/session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:window.location.pathname+window.location.search})});if(!e.ok)throw new Error(`HTTP session init failed: ${e.status}`);let t=await e.json();this.sessionId=t.sessionId,console.log("PyHTML: HTTP transport connected"),this.connected=!0,this.startPolling()}catch(e){throw console.error("PyHTML: HTTP transport connection failed",e),e}}async startPolling(){if(!this.polling)for(this.polling=!0;this.polling&&this.connected;)try{this.pollAbortController=new AbortController;let e=await fetch(`${this.baseUrl}/poll?session=${this.sessionId}`,{method:"GET",signal:this.pollAbortController.signal,headers:{Accept:"application/json"}});if(!e.ok){if(e.status===404){console.warn("PyHTML: HTTP session expired, reconnecting..."),this.connected=!1,await this.connect();return}throw new Error(`Poll failed: ${e.status}`)}let t=await e.json();for(let r of t)this.notifyHandlers(r)}catch(e){if(e instanceof Error&&e.name==="AbortError")break;console.error("PyHTML: HTTP poll error",e),await this.sleep(1e3)}}async send(e){if(!this.connected||!this.sessionId){console.warn("PyHTML: Cannot send message, HTTP transport not connected");return}try{let t=await fetch(`${this.baseUrl}/event`,{method:"POST",headers:{"Content-Type":"application/json","X-PyHTML-Session":this.sessionId},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Event send failed: ${t.status}`);let r=await t.json();this.notifyHandlers(r)}catch(t){console.error("PyHTML: HTTP send error",t)}}disconnect(){this.polling=!1,this.connected=!1,this.pollAbortController&&(this.pollAbortController.abort(),this.pollAbortController=null),this.sessionId=null}sleep(e){return new Promise(t=>setTimeout(t,e))}};var we={enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},N=class{constructor(n={}){this.transport=null;this.messageHandlers=[];this.config={...we,...n}}async connect(){let n=this.getTransportPriority();for(let e of n)try{console.log(`PyHTML: Trying ${e.name}...`),this.transport=new e;for(let t of this.messageHandlers)this.transport.onMessage(t);await this.transport.connect(),console.log(`PyHTML: Connected via ${this.transport.name}`);return}catch(t){console.warn(`PyHTML: ${e.name} failed, trying next...`,t),this.transport=null}throw new Error("PyHTML: All transports failed")}getTransportPriority(){let n=[];return this.config.enableWebTransport&&x.isSupported()&&window.location.protocol==="https:"&&n.push(x),this.config.enableWebSocket&&typeof WebSocket<"u"&&n.push(C),this.config.enableHTTP&&n.push(R),n}send(n){this.transport?this.transport.send(n):console.warn("PyHTML: No active transport")}onMessage(n){this.messageHandlers.push(n),this.transport&&this.transport.onMessage(n)}disconnect(){this.transport&&(this.transport.disconnect(),this.transport=null)}getActiveTransport(){return this.transport?.name||null}isConnected(){return this.transport?.isConnected()||!1}};var ie=11;function be(a,n){var e=n.attributes,t,r,o,d,u;if(!(n.nodeType===ie||a.nodeType===ie)){for(var P=e.length-1;P>=0;P--)t=e[P],r=t.name,o=t.namespaceURI,d=t.value,o?(r=t.localName||r,u=a.getAttributeNS(o,r),u!==d&&(t.prefix==="xmlns"&&(r=t.name),a.setAttributeNS(o,r,d))):(u=a.getAttribute(r),u!==d&&a.setAttribute(r,d));for(var S=a.attributes,v=S.length-1;v>=0;v--)t=S[v],r=t.name,o=t.namespaceURI,o?(r=t.localName||r,n.hasAttributeNS(o,r)||a.removeAttributeNS(o,r)):n.hasAttribute(r)||a.removeAttribute(r)}}var V,Me="http://www.w3.org/1999/xhtml",f=typeof document>"u"?void 0:document,Pe=!!f&&"content"in f.createElement("template"),Se=!!f&&f.createRange&&"createContextualFragment"in f.createRange();function Ae(a){var n=f.createElement("template");return n.innerHTML=a,n.content.childNodes[0]}function He(a){V||(V=f.createRange(),V.selectNode(f.body));var n=V.createContextualFragment(a);return n.childNodes[0]}function xe(a){var n=f.createElement("body");return n.innerHTML=a,n.childNodes[0]}function Le(a){return a=a.trim(),Pe?Ae(a):Se?He(a):xe(a)}function z(a,n){var e=a.nodeName,t=n.nodeName,r,o;return e===t?!0:(r=e.charCodeAt(0),o=t.charCodeAt(0),r<=90&&o>=97?e===t.toUpperCase():o<=90&&r>=97?t===e.toUpperCase():!1)}function ke(a,n){return!n||n===Me?f.createElement(a):f.createElementNS(n,a)}function Ee(a,n){for(var e=a.firstChild;e;){var t=e.nextSibling;n.appendChild(e),e=t}return n}function ee(a,n,e){a[e]!==n[e]&&(a[e]=n[e],a[e]?a.setAttribute(e,""):a.removeAttribute(e))}var oe={OPTION:function(a,n){var e=a.parentNode;if(e){var t=e.nodeName.toUpperCase();t==="OPTGROUP"&&(e=e.parentNode,t=e&&e.nodeName.toUpperCase()),t==="SELECT"&&!e.hasAttribute("multiple")&&(a.hasAttribute("selected")&&!n.selected&&(a.setAttribute("selected","selected"),a.removeAttribute("selected")),e.selectedIndex=-1)}ee(a,n,"selected")},INPUT:function(a,n){ee(a,n,"checked"),ee(a,n,"disabled"),a.value!==n.value&&(a.value=n.value),n.hasAttribute("value")||a.removeAttribute("value")},TEXTAREA:function(a,n){var e=n.value;a.value!==e&&(a.value=e);var t=a.firstChild;if(t){var r=t.nodeValue;if(r==e||!e&&r==a.placeholder)return;t.nodeValue=e}},SELECT:function(a,n){if(!n.hasAttribute("multiple")){for(var e=-1,t=0,r=a.firstChild,o,d;r;)if(d=r.nodeName&&r.nodeName.toUpperCase(),d==="OPTGROUP")o=r,r=o.firstChild,r||(r=o.nextSibling,o=null);else{if(d==="OPTION"){if(r.hasAttribute("selected")){e=t;break}t++}r=r.nextSibling,!r&&o&&(r=o.nextSibling,o=null)}a.selectedIndex=e}}},W=1,le=11,ce=3,de=8;function M(){}function Ce(a){if(a)return a.getAttribute&&a.getAttribute("id")||a.id}function Re(a){return function(e,t,r){if(r||(r={}),typeof t=="string")if(e.nodeName==="#document"||e.nodeName==="HTML"||e.nodeName==="BODY"){var o=t;t=f.createElement("html"),t.innerHTML=o}else t=Le(t);else t.nodeType===le&&(t=t.firstElementChild);var d=r.getNodeKey||Ce,u=r.onBeforeNodeAdded||M,P=r.onNodeAdded||M,S=r.onBeforeElUpdated||M,v=r.onElUpdated||M,m=r.onBeforeNodeDiscarded||M,A=r.onNodeDiscarded||M,H=r.onBeforeElChildrenUpdated||M,J=r.skipFromChildren||M,L=r.addChild||function(s,i){return s.appendChild(i)},U=r.childrenOnly===!0,g=Object.create(null),O=[];function I(s){O.push(s)}function re(s,i){if(s.nodeType===W)for(var p=s.firstChild;p;){var l=void 0;i&&(l=d(p))?I(l):(A(p),p.firstChild&&re(p,i)),p=p.nextSibling}}function _(s,i,p){m(s)!==!1&&(i&&i.removeChild(s),A(s),re(s,p))}function X(s){if(s.nodeType===W||s.nodeType===le)for(var i=s.firstChild;i;){var p=d(i);p&&(g[p]=i),X(i),i=i.nextSibling}}X(e);function K(s){P(s);for(var i=s.firstChild;i;){var p=i.nextSibling,l=d(i);if(l){var c=g[l];c&&z(i,c)?(i.parentNode.replaceChild(c,i),$(c,i)):K(i)}else K(i);i=p}}function pe(s,i,p){for(;i;){var l=i.nextSibling;(p=d(i))?I(p):_(i,s,!0),i=l}}function $(s,i,p){var l=d(i);if(l&&delete g[l],!p){var c=S(s,i);if(c===!1||(c instanceof HTMLElement&&(s=c,X(s)),a(s,i),v(s),H(s,i)===!1))return}s.nodeName!=="TEXTAREA"?he(s,i):oe.TEXTAREA(s,i)}function he(s,i){var p=J(s,i),l=i.firstChild,c=s.firstChild,k,T,E,B,y;e:for(;l;){for(B=l.nextSibling,k=d(l);!p&&c;){if(E=c.nextSibling,l.isSameNode&&l.isSameNode(c)){l=B,c=E;continue e}T=d(c);var j=c.nodeType,w=void 0;if(j===l.nodeType&&(j===W?(k?k!==T&&((y=g[k])?E===y?w=!1:(s.insertBefore(y,c),T?I(T):_(c,s,!0),c=y,T=d(c)):w=!1):T&&(w=!1),w=w!==!1&&z(c,l),w&&$(c,l)):(j===ce||j==de)&&(w=!0,c.nodeValue!==l.nodeValue&&(c.nodeValue=l.nodeValue))),w){l=B,c=E;continue e}T?I(T):_(c,s,!0),c=E}if(k&&(y=g[k])&&z(y,l))p||L(s,y),$(y,l);else{var Q=u(l);Q!==!1&&(Q&&(l=Q),l.actualize&&(l=l.actualize(s.ownerDocument||f)),L(s,l),K(l))}l=B,c=E}pe(s,c,T);var se=oe[s.nodeName];se&&se(s,i)}var h=e,F=h.nodeType,ae=t.nodeType;if(!U){if(F===W)ae===W?z(e,t)||(A(e),h=Ee(e,ke(t.nodeName,t.namespaceURI))):h=t;else if(F===ce||F===de){if(ae===F)return h.nodeValue!==t.nodeValue&&(h.nodeValue=t.nodeValue),h;h=t}}if(h===t)A(e);else{if(t.isSameNode&&t.isSameNode(h))return;if($(h,t,U),O)for(var Y=0,ue=O.length;Y<ue;Y++){var q=g[O[Y]];q&&_(q,q.parentNode,!1)}}return!U&&h!==e&&e.parentNode&&(h.actualize&&(h=h.actualize(e.ownerDocument||f)),e.parentNode.replaceChild(h,e)),h}}var Ne=Re(be),te=Ne;var D=class{update(n){te?te(document.documentElement,n,{onBeforeElUpdated:(e,t)=>{if(e===document.activeElement&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA")){let r=t.getAttribute("value")||"",o=e.value||"";(o.startsWith(r)||r.startsWith(o))&&(t.setAttribute("value",o),t.value=o,e.tagName==="TEXTAREA"&&(t.textContent=o))}return!0}}):(document.open(),document.write(n),document.close())}};var De={autoInit:!0,enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},G=class{constructor(n={}){this.initialized=!1;this.siblingPaths=[];this.pathRegexes=[];this.config={...De,...n},this.transport=new N(this.config),this.updater=new D}async init(){if(!this.initialized){this.initialized=!0,this.transport.onMessage(n=>this.handleMessage(n));try{await this.transport.connect()}catch(n){console.error("PyHTML: Failed to connect:",n)}this.loadSPAMetadata(),this.setupSPANavigation(),this.setupEventInterceptors(),console.log(`PyHTML: Initialized (transport: ${this.transport.getActiveTransport()}, spa_paths: ${this.siblingPaths.length})`)}}loadSPAMetadata(){let n=document.getElementById("_pyhtml_spa_meta");if(n)try{let e=JSON.parse(n.textContent||"{}");this.siblingPaths=e.sibling_paths||[],this.pathRegexes=this.siblingPaths.map(t=>this.patternToRegex(t))}catch(e){console.warn("PyHTML: Failed to parse SPA metadata",e)}}patternToRegex(n){let e=n.replace(/[.+?^${}()|[\]\\]/g,"\\$&");return e=e.replace(/:(\w+)(:\w+)?/g,"([^/]+)"),e=e.replace(/\{(\w+)(:\w+)?\}/g,"([^/]+)"),new RegExp(`^${e}$`)}isSiblingPath(n){return this.pathRegexes.some(e=>e.test(n))}setupSPANavigation(){this.siblingPaths.length!==0&&(document.addEventListener("click",n=>{let e=n.target.closest("a[href]");e&&e.origin===window.location.origin&&this.isSiblingPath(e.pathname)&&(n.preventDefault(),this.navigateTo(e.pathname+e.search))}),window.addEventListener("popstate",()=>{this.sendRelocate(window.location.pathname+window.location.search)}))}navigateTo(n){history.pushState({},"",n),this.sendRelocate(n)}sendRelocate(n){let e={type:"relocate",path:n};this.transport.send(e)}setupEventInterceptors(){document.addEventListener("click",e=>{let t=e.target.closest("[data-on-click]");if(t){e.preventDefault();let r=t.getAttribute("data-on-click");r&&this.sendEvent(r,{type:"click",id:t.id,value:t.value,args:this.getArgs(t)})}}),document.addEventListener("submit",async e=>{let t=e.target.closest("[data-on-submit]");if(t){e.preventDefault();let r=t.getAttribute("data-on-submit");if(r){let o=t,d=new FormData(o),u={};d.forEach((v,m)=>{v instanceof File||(u[m]=v.toString())});let P=o.querySelectorAll('input[type="file"]'),S=[];P.forEach(v=>{let m=v,A=m.name;if(A&&m.files&&m.files.length>0){let H=m.files[0];if(H){let J=new Promise((L,U)=>{let g=new FileReader;g.onload=()=>L(g.result),g.onerror=U,g.readAsDataURL(H)}).then(L=>{u[A]={name:H.name,type:H.type,size:H.size,content:L}});S.push(J)}}}),await Promise.all(S),this.sendEvent(r,{type:"submit",id:t.id,formData:u,args:this.getArgs(t)})}}});let n;document.addEventListener("input",e=>{let t=e.target.closest("[data-on-input]");t&&(clearTimeout(n),n=window.setTimeout(()=>{let r=t.getAttribute("data-on-input");r&&this.sendEvent(r,{type:"input",id:t.id,value:t.value,args:this.getArgs(t)})},150))}),document.addEventListener("change",e=>{let t=e.target.closest("[data-on-change]");if(t){let r=t.getAttribute("data-on-change");r&&this.sendEvent(r,{type:"change",id:t.id,value:t.value,checked:t.checked,args:this.getArgs(t)})}})}getArgs(n){let e={};if(n instanceof HTMLElement){for(let t in n.dataset)if(t.startsWith("arg"))try{e[t]=JSON.parse(n.dataset[t]||"null")}catch{console.warn("PyHTML: Failed to parse arg",t,n.dataset[t]),e[t]=n.dataset[t]}}return e}sendEvent(n,e){let t={type:"event",handler:n,path:window.location.pathname+window.location.search,data:e};this.transport.send(t)}handleMessage(n){switch(n.type){case"update":n.html&&this.updater.update(n.html);break;case"reload":console.log("PyHTML: Reloading..."),window.location.reload();break;case"error":console.error("PyHTML: Server error:",n.error);break;case"console":if(n.lines){let e="PyHTML Server:",t=n.lines;n.level==="error"?console.error(e,...t):n.level==="warn"?console.warn(e,...t):console.log(e,...t)}break;default:console.warn("PyHTML: Unknown message type",n)}}getTransport(){return this.transport.getActiveTransport()}disconnect(){this.transport.disconnect()}},ne=new G;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>ne.init()):ne.init();return ye(Ue);})();
