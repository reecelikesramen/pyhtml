/* PyHTML Client v0.0.1 - https://github.com/reecelikesramen/pyhtml */
"use strict";var PyHTML=(()=>{var K=Object.defineProperty;var ge=Object.getOwnPropertyDescriptor;var fe=Object.getOwnPropertyNames;var ve=Object.prototype.hasOwnProperty;var Te=(a,n)=>{for(var e in n)K(a,e,{get:n[e],enumerable:!0})},me=(a,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of fe(n))!ve.call(a,r)&&r!==e&&K(a,r,{get:()=>n[r],enumerable:!(t=ge(n,r))||t.enumerable});return a};var be=a=>me(K({},"__esModule",{value:!0}),a);var Ue={};Te(Ue,{DOMUpdater:()=>L,HTTPTransport:()=>A,PyHTMLApp:()=>F,TransportManager:()=>x,WebSocketTransport:()=>H,WebTransportTransport:()=>w,app:()=>Q});var m=class{constructor(){this.messageHandlers=[];this.connected=!1}onMessage(n){this.messageHandlers.push(n)}isConnected(){return this.connected}notifyHandlers(n){for(let e of this.messageHandlers)try{e(n)}catch(t){console.error("PyHTML: Error in message handler",t)}}};var w=class a extends m{constructor(e){super();this.name="WebTransport";this.transport=null;this.writer=null;this.encoder=new TextEncoder;this.decoder=new TextDecoder;this.url=e||this.getDefaultUrl()}getDefaultUrl(){return`https://${window.location.host}/_pyhtml/webtransport`}static isSupported(){return typeof WebTransport<"u"}async connect(){if(!a.isSupported())throw new Error("WebTransport not supported in this browser");try{let e={},t=window.PYHTML_CERT_HASH;t&&Array.isArray(t)&&(e.serverCertificateHashes=[{algorithm:"sha-256",value:new Uint8Array(t)}],console.log("PyHTML: Using explicit certificate hash for WebTransport")),this.transport=new WebTransport(this.url,e),await this.transport.ready,console.log("PyHTML: WebTransport ready"),this.connected=!0,this.startReading()}catch(e){throw this.handleDisconnect(),e}}async startReading(){if(!this.transport)return;let e=this.transport.incomingBidirectionalStreams.getReader();try{for(;;){let{value:t,done:r}=await e.read();if(r)break;this.handleStream(t)}}catch(t){this.connected&&(console.error("PyHTML: WebTransport read error",t),this.handleDisconnect())}}async handleStream(e){let t=e.readable.getReader();try{for(;;){let{value:r,done:o}=await t.read();if(o)break;if(r){let d=this.decoder.decode(r);try{let g=JSON.parse(d);this.notifyHandlers(g)}catch(g){console.error("PyHTML: Error parsing WebTransport message",g)}}}}catch(r){console.error("PyHTML: Stream read error",r)}}async send(e){if(!this.transport||!this.connected){console.warn("PyHTML: Cannot send message, WebTransport not connected");return}try{let t=await this.transport.createBidirectionalStream(),r=t.writable.getWriter(),o=this.encoder.encode(JSON.stringify(e));await r.write(o),await r.close(),this.handleStream(t)}catch(t){console.error("PyHTML: WebTransport send error",t)}}disconnect(){this.transport&&(this.transport.close(),this.transport=null),this.writer=null,this.connected=!1}handleDisconnect(){this.connected=!1,this.transport=null,this.writer=null}};var H=class extends m{constructor(e){super();this.name="WebSocket";this.socket=null;this.reconnectAttempts=0;this.maxReconnectDelay=5e3;this.shouldReconnect=!0;this.url=e||this.getDefaultUrl()}getDefaultUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_pyhtml/ws`}connect(){return new Promise((e,t)=>{try{this.socket=new WebSocket(this.url),this.socket.onopen=()=>{console.log("PyHTML: WebSocket connected"),this.connected=!0,this.reconnectAttempts=0,e()},this.socket.onmessage=r=>{try{let o=JSON.parse(r.data);this.notifyHandlers(o)}catch(o){console.error("PyHTML: Error parsing WebSocket message",o)}},this.socket.onclose=()=>{console.log("PyHTML: WebSocket disconnected"),this.connected=!1,this.shouldReconnect&&this.scheduleReconnect()},this.socket.onerror=r=>{console.error("PyHTML: WebSocket error",r),this.connected||t(new Error("WebSocket connection failed"))}}catch(r){t(r)}})}send(e){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(JSON.stringify(e)):console.warn("PyHTML: Cannot send message, WebSocket not open")}disconnect(){this.shouldReconnect=!1,this.socket&&(this.socket.close(),this.socket=null),this.connected=!1}scheduleReconnect(){let e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);console.log(`PyHTML: Reconnecting in ${e}ms...`),setTimeout(()=>{this.reconnectAttempts++,this.connect().catch(()=>{})},e)}};var A=class extends m{constructor(e){super();this.name="HTTP";this.polling=!1;this.pollAbortController=null;this.sessionId=null;this.baseUrl=e||`${window.location.origin}/_pyhtml`}async connect(){try{let e=await fetch(`${this.baseUrl}/session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:window.location.pathname+window.location.search})});if(!e.ok)throw new Error(`HTTP session init failed: ${e.status}`);let t=await e.json();this.sessionId=t.sessionId,console.log("PyHTML: HTTP transport connected"),this.connected=!0,this.startPolling()}catch(e){throw console.error("PyHTML: HTTP transport connection failed",e),e}}async startPolling(){if(!this.polling)for(this.polling=!0;this.polling&&this.connected;)try{this.pollAbortController=new AbortController;let e=await fetch(`${this.baseUrl}/poll?session=${this.sessionId}`,{method:"GET",signal:this.pollAbortController.signal,headers:{Accept:"application/json"}});if(!e.ok){if(e.status===404){console.warn("PyHTML: HTTP session expired, reconnecting..."),this.connected=!1,await this.connect();return}throw new Error(`Poll failed: ${e.status}`)}let t=await e.json();for(let r of t)this.notifyHandlers(r)}catch(e){if(e instanceof Error&&e.name==="AbortError")break;console.error("PyHTML: HTTP poll error",e),await this.sleep(1e3)}}async send(e){if(!this.connected||!this.sessionId){console.warn("PyHTML: Cannot send message, HTTP transport not connected");return}try{let t=await fetch(`${this.baseUrl}/event`,{method:"POST",headers:{"Content-Type":"application/json","X-PyHTML-Session":this.sessionId},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Event send failed: ${t.status}`);let r=await t.json();this.notifyHandlers(r)}catch(t){console.error("PyHTML: HTTP send error",t)}}disconnect(){this.polling=!1,this.connected=!1,this.pollAbortController&&(this.pollAbortController.abort(),this.pollAbortController=null),this.sessionId=null}sleep(e){return new Promise(t=>setTimeout(t,e))}};var ye={enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},x=class{constructor(n={}){this.transport=null;this.messageHandlers=[];this.config={...ye,...n}}async connect(){let n=this.getTransportPriority();for(let e of n)try{console.log(`PyHTML: Trying ${e.name}...`),this.transport=new e;for(let t of this.messageHandlers)this.transport.onMessage(t);await this.transport.connect(),console.log(`PyHTML: Connected via ${this.transport.name}`);return}catch(t){console.warn(`PyHTML: ${e.name} failed, trying next...`,t),this.transport=null}throw new Error("PyHTML: All transports failed")}getTransportPriority(){let n=[];return this.config.enableWebTransport&&w.isSupported()&&window.location.protocol==="https:"&&n.push(w),this.config.enableWebSocket&&typeof WebSocket<"u"&&n.push(H),this.config.enableHTTP&&n.push(A),n}send(n){this.transport?this.transport.send(n):console.warn("PyHTML: No active transport")}onMessage(n){this.messageHandlers.push(n),this.transport&&this.transport.onMessage(n)}disconnect(){this.transport&&(this.transport.disconnect(),this.transport=null)}getActiveTransport(){return this.transport?.name||null}isConnected(){return this.transport?.isConnected()||!1}};var re=11;function we(a,n){var e=n.attributes,t,r,o,d,g;if(!(n.nodeType===re||a.nodeType===re)){for(var y=e.length-1;y>=0;y--)t=e[y],r=t.name,o=t.namespaceURI,d=t.value,o?(r=t.localName||r,g=a.getAttributeNS(o,r),g!==d&&(t.prefix==="xmlns"&&(r=t.name),a.setAttributeNS(o,r,d))):(g=a.getAttribute(r),g!==d&&a.setAttribute(r,d));for(var C=a.attributes,k=C.length-1;k>=0;k--)t=C[k],r=t.name,o=t.namespaceURI,o?(r=t.localName||r,n.hasAttributeNS(o,r)||a.removeAttributeNS(o,r)):n.hasAttribute(r)||a.removeAttribute(r)}}var $,Me="http://www.w3.org/1999/xhtml",u=typeof document>"u"?void 0:document,Pe=!!u&&"content"in u.createElement("template"),Se=!!u&&u.createRange&&"createContextualFragment"in u.createRange();function He(a){var n=u.createElement("template");return n.innerHTML=a,n.content.childNodes[0]}function Ae(a){$||($=u.createRange(),$.selectNode(u.body));var n=$.createContextualFragment(a);return n.childNodes[0]}function xe(a){var n=u.createElement("body");return n.innerHTML=a,n.childNodes[0]}function Le(a){return a=a.trim(),Pe?He(a):Se?Ae(a):xe(a)}function B(a,n){var e=a.nodeName,t=n.nodeName,r,o;return e===t?!0:(r=e.charCodeAt(0),o=t.charCodeAt(0),r<=90&&o>=97?e===t.toUpperCase():o<=90&&r>=97?t===e.toUpperCase():!1)}function ke(a,n){return!n||n===Me?u.createElement(a):u.createElementNS(n,a)}function Ee(a,n){for(var e=a.firstChild;e;){var t=e.nextSibling;n.appendChild(e),e=t}return n}function Y(a,n,e){a[e]!==n[e]&&(a[e]=n[e],a[e]?a.setAttribute(e,""):a.removeAttribute(e))}var ae={OPTION:function(a,n){var e=a.parentNode;if(e){var t=e.nodeName.toUpperCase();t==="OPTGROUP"&&(e=e.parentNode,t=e&&e.nodeName.toUpperCase()),t==="SELECT"&&!e.hasAttribute("multiple")&&(a.hasAttribute("selected")&&!n.selected&&(a.setAttribute("selected","selected"),a.removeAttribute("selected")),e.selectedIndex=-1)}Y(a,n,"selected")},INPUT:function(a,n){Y(a,n,"checked"),Y(a,n,"disabled"),a.value!==n.value&&(a.value=n.value),n.hasAttribute("value")||a.removeAttribute("value")},TEXTAREA:function(a,n){var e=n.value;a.value!==e&&(a.value=e);var t=a.firstChild;if(t){var r=t.nodeValue;if(r==e||!e&&r==a.placeholder)return;t.nodeValue=e}},SELECT:function(a,n){if(!n.hasAttribute("multiple")){for(var e=-1,t=0,r=a.firstChild,o,d;r;)if(d=r.nodeName&&r.nodeName.toUpperCase(),d==="OPTGROUP")o=r,r=o.firstChild,r||(r=o.nextSibling,o=null);else{if(d==="OPTION"){if(r.hasAttribute("selected")){e=t;break}t++}r=r.nextSibling,!r&&o&&(r=o.nextSibling,o=null)}a.selectedIndex=e}}},E=1,se=11,ie=3,oe=8;function b(){}function Ce(a){if(a)return a.getAttribute&&a.getAttribute("id")||a.id}function Re(a){return function(e,t,r){if(r||(r={}),typeof t=="string")if(e.nodeName==="#document"||e.nodeName==="HTML"||e.nodeName==="BODY"){var o=t;t=u.createElement("html"),t.innerHTML=o}else t=Le(t);else t.nodeType===se&&(t=t.firstElementChild);var d=r.getNodeKey||Ce,g=r.onBeforeNodeAdded||b,y=r.onNodeAdded||b,C=r.onBeforeElUpdated||b,k=r.onElUpdated||b,le=r.onBeforeNodeDiscarded||b,R=r.onNodeDiscarded||b,ce=r.onBeforeElChildrenUpdated||b,de=r.skipFromChildren||b,Z=r.addChild||function(s,i){return s.appendChild(i)},j=r.childrenOnly===!0,M=Object.create(null),N=[];function D(s){N.push(s)}function ee(s,i){if(s.nodeType===E)for(var p=s.firstChild;p;){var l=void 0;i&&(l=d(p))?D(l):(R(p),p.firstChild&&ee(p,i)),p=p.nextSibling}}function U(s,i,p){le(s)!==!1&&(i&&i.removeChild(s),R(s),ee(s,p))}function V(s){if(s.nodeType===E||s.nodeType===se)for(var i=s.firstChild;i;){var p=d(i);p&&(M[p]=i),V(i),i=i.nextSibling}}V(e);function G(s){y(s);for(var i=s.firstChild;i;){var p=i.nextSibling,l=d(i);if(l){var c=M[l];c&&B(i,c)?(i.parentNode.replaceChild(c,i),W(c,i)):G(i)}else G(i);i=p}}function pe(s,i,p){for(;i;){var l=i.nextSibling;(p=d(i))?D(p):U(i,s,!0),i=l}}function W(s,i,p){var l=d(i);if(l&&delete M[l],!p){var c=C(s,i);if(c===!1||(c instanceof HTMLElement&&(s=c,V(s)),a(s,i),k(s),ce(s,i)===!1))return}s.nodeName!=="TEXTAREA"?he(s,i):ae.TEXTAREA(s,i)}function he(s,i){var p=de(s,i),l=i.firstChild,c=s.firstChild,P,f,S,I,v;e:for(;l;){for(I=l.nextSibling,P=d(l);!p&&c;){if(S=c.nextSibling,l.isSameNode&&l.isSameNode(c)){l=I,c=S;continue e}f=d(c);var _=c.nodeType,T=void 0;if(_===l.nodeType&&(_===E?(P?P!==f&&((v=M[P])?S===v?T=!1:(s.insertBefore(v,c),f?D(f):U(c,s,!0),c=v,f=d(c)):T=!1):f&&(T=!1),T=T!==!1&&B(c,l),T&&W(c,l)):(_===ie||_==oe)&&(T=!0,c.nodeValue!==l.nodeValue&&(c.nodeValue=l.nodeValue))),T){l=I,c=S;continue e}f?D(f):U(c,s,!0),c=S}if(P&&(v=M[P])&&B(v,l))p||Z(s,v),W(v,l);else{var X=g(l);X!==!1&&(X&&(l=X),l.actualize&&(l=l.actualize(s.ownerDocument||u)),Z(s,l),G(l))}l=I,c=S}pe(s,c,f);var ne=ae[s.nodeName];ne&&ne(s,i)}var h=e,O=h.nodeType,te=t.nodeType;if(!j){if(O===E)te===E?B(e,t)||(R(e),h=Ee(e,ke(t.nodeName,t.namespaceURI))):h=t;else if(O===ie||O===oe){if(te===O)return h.nodeValue!==t.nodeValue&&(h.nodeValue=t.nodeValue),h;h=t}}if(h===t)R(e);else{if(t.isSameNode&&t.isSameNode(h))return;if(W(h,t,j),N)for(var z=0,ue=N.length;z<ue;z++){var J=M[N[z]];J&&U(J,J.parentNode,!1)}}return!j&&h!==e&&e.parentNode&&(h.actualize&&(h=h.actualize(e.ownerDocument||u)),e.parentNode.replaceChild(h,e)),h}}var Ne=Re(we),q=Ne;var L=class{update(n){q?q(document.documentElement,n,{onBeforeElUpdated:(e,t)=>{if(e===document.activeElement&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA")){let r=t.getAttribute("value")||"",o=e.value||"";(o.startsWith(r)||r.startsWith(o))&&(t.setAttribute("value",o),t.value=o,e.tagName==="TEXTAREA"&&(t.textContent=o))}return!0}}):(document.open(),document.write(n),document.close())}};var De={autoInit:!0,enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},F=class{constructor(n={}){this.initialized=!1;this.siblingPaths=[];this.pathRegexes=[];this.config={...De,...n},this.transport=new x(this.config),this.updater=new L}async init(){if(!this.initialized){this.initialized=!0,this.transport.onMessage(n=>this.handleMessage(n));try{await this.transport.connect()}catch(n){console.error("PyHTML: Failed to connect:",n)}this.loadSPAMetadata(),this.setupSPANavigation(),this.setupEventInterceptors(),console.log(`PyHTML: Initialized (transport: ${this.transport.getActiveTransport()}, spa_paths: ${this.siblingPaths.length})`)}}loadSPAMetadata(){let n=document.getElementById("_pyhtml_spa_meta");if(n)try{let e=JSON.parse(n.textContent||"{}");this.siblingPaths=e.sibling_paths||[],this.pathRegexes=this.siblingPaths.map(t=>this.patternToRegex(t))}catch(e){console.warn("PyHTML: Failed to parse SPA metadata",e)}}patternToRegex(n){let e=n.replace(/[.+?^${}()|[\]\\]/g,"\\$&");return e=e.replace(/:(\w+)(:\w+)?/g,"([^/]+)"),e=e.replace(/\{(\w+)(:\w+)?\}/g,"([^/]+)"),new RegExp(`^${e}$`)}isSiblingPath(n){return this.pathRegexes.some(e=>e.test(n))}setupSPANavigation(){this.siblingPaths.length!==0&&(document.addEventListener("click",n=>{let e=n.target.closest("a[href]");e&&e.origin===window.location.origin&&this.isSiblingPath(e.pathname)&&(n.preventDefault(),this.navigateTo(e.pathname+e.search))}),window.addEventListener("popstate",()=>{this.sendRelocate(window.location.pathname+window.location.search)}))}navigateTo(n){history.pushState({},"",n),this.sendRelocate(n)}sendRelocate(n){let e={type:"relocate",path:n};this.transport.send(e)}setupEventInterceptors(){document.addEventListener("click",e=>{let t=e.target.closest("[data-on-click]");if(t){e.preventDefault();let r=t.getAttribute("data-on-click");r&&this.sendEvent(r,{type:"click",id:t.id,value:t.value,args:this.getArgs(t)})}}),document.addEventListener("submit",e=>{let t=e.target.closest("[data-on-submit]");if(t){e.preventDefault();let r=t.getAttribute("data-on-submit");if(r){let o=new FormData(t),d={};o.forEach((g,y)=>{d[y]=g.toString()}),this.sendEvent(r,{type:"submit",id:t.id,formData:d,args:this.getArgs(t)})}}});let n;document.addEventListener("input",e=>{let t=e.target.closest("[data-on-input]");t&&(clearTimeout(n),n=window.setTimeout(()=>{let r=t.getAttribute("data-on-input");r&&this.sendEvent(r,{type:"input",id:t.id,value:t.value,args:this.getArgs(t)})},150))}),document.addEventListener("change",e=>{let t=e.target.closest("[data-on-change]");if(t){let r=t.getAttribute("data-on-change");r&&this.sendEvent(r,{type:"change",id:t.id,value:t.value,checked:t.checked,args:this.getArgs(t)})}})}getArgs(n){let e={};if(n instanceof HTMLElement){for(let t in n.dataset)if(t.startsWith("arg"))try{e[t]=JSON.parse(n.dataset[t]||"null")}catch{console.warn("PyHTML: Failed to parse arg",t,n.dataset[t]),e[t]=n.dataset[t]}}return e}sendEvent(n,e){let t={type:"event",handler:n,path:window.location.pathname+window.location.search,data:e};this.transport.send(t)}handleMessage(n){switch(n.type){case"update":n.html&&this.updater.update(n.html);break;case"reload":console.log("PyHTML: Reloading..."),window.location.reload();break;case"error":console.error("PyHTML: Server error:",n.error);break;case"console":if(n.lines){let e="PyHTML Server:",t=n.lines;n.level==="error"?console.error(e,...t):n.level==="warn"?console.warn(e,...t):console.log(e,...t)}break;default:console.warn("PyHTML: Unknown message type",n)}}getTransport(){return this.transport.getActiveTransport()}disconnect(){this.transport.disconnect()}},Q=new F;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>Q.init()):Q.init();return be(Ue);})();
