/* PyHTML Client dev v0.0.1 - https://github.com/reecelikesramen/pyhtml */
"use strict";var PyHTML=(()=>{var ce=Object.defineProperty;var Xe=Object.getOwnPropertyDescriptor;var Ge=Object.getOwnPropertyNames;var Ye=Object.prototype.hasOwnProperty;var Je=(r,e,t)=>e in r?ce(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var qe=(r,e)=>{for(var t in e)ce(r,t,{get:e[t],enumerable:!0})},Ze=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ge(e))!Ye.call(r,n)&&n!==t&&ce(r,n,{get:()=>e[n],enumerable:!(s=Xe(e,n))||s.enumerable});return r};var Qe=r=>Ze(ce({},"__esModule",{value:!0}),r);var a=(r,e,t)=>(Je(r,typeof e!="symbol"?e+"":e,t),t);var _t={};qe(_t,{DOMUpdater:()=>X,ErrorTraceHandler:()=>J,HTTPTransport:()=>K,PyHTMLApp:()=>G,PyHTMLDevApp:()=>q,StatusOverlay:()=>Y,TransportManager:()=>V,WebSocketTransport:()=>O,WebTransportTransport:()=>C,app:()=>Pe});var k=class{constructor(){this.messageHandlers=[];this.statusHandlers=[];this.connected=!1}onMessage(e){this.messageHandlers.push(e)}onStatusChange(e){this.statusHandlers.push(e)}isConnected(){return this.connected}notifyHandlers(e){for(let t of this.messageHandlers)try{t(e)}catch(s){console.error("PyHTML: Error in message handler",s)}}notifyStatus(e){if(this.connected!==e){this.connected=e;for(let t of this.statusHandlers)try{t(e)}catch(s){console.error("PyHTML: Error in status handler",s)}}}};var C=class r extends k{constructor(t){super();this.name="WebTransport";this.transport=null;this.writer=null;this.encoder=new TextEncoder;this.decoder=new TextDecoder;this.url=t||this.getDefaultUrl()}getDefaultUrl(){return`https://${window.location.host}/_pyhtml/webtransport`}static isSupported(){return typeof WebTransport<"u"}async connect(){if(!r.isSupported())throw new Error("WebTransport not supported in this browser");try{let t={},s=window.PYHTML_CERT_HASH;s&&Array.isArray(s)&&(t.serverCertificateHashes=[{algorithm:"sha-256",value:new Uint8Array(s)}],console.log("PyHTML: Using explicit certificate hash for WebTransport")),this.transport=new WebTransport(this.url,t),await this.transport.ready,console.log("PyHTML: WebTransport ready"),this.connected=!0,this.startReading()}catch(t){throw this.handleDisconnect(),t}}async startReading(){if(!this.transport)return;let t=this.transport.incomingBidirectionalStreams.getReader();try{for(;;){let{value:s,done:n}=await t.read();if(n)break;this.handleStream(s)}}catch(s){this.connected&&(console.error("PyHTML: WebTransport read error",s),this.handleDisconnect())}}async handleStream(t){let s=t.readable.getReader();try{for(;;){let{value:n,done:i}=await s.read();if(i)break;if(n){let o=this.decoder.decode(n);try{let h=JSON.parse(o);this.notifyHandlers(h)}catch(h){console.error("PyHTML: Error parsing WebTransport message",h)}}}}catch(n){console.error("PyHTML: Stream read error",n)}}async send(t){if(!this.transport||!this.connected){console.warn("PyHTML: Cannot send message, WebTransport not connected");return}try{let s=await this.transport.createBidirectionalStream(),n=s.writable.getWriter(),i=this.encoder.encode(JSON.stringify(t));await n.write(i),await n.close(),this.handleStream(s)}catch(s){console.error("PyHTML: WebTransport send error",s)}}disconnect(){this.transport&&(this.transport.close(),this.transport=null),this.writer=null,this.connected=!1}handleDisconnect(){this.connected=!1,this.transport=null,this.writer=null}};function Le(r){let e=r.length,t=0,s=0;for(;s<e;){let n=r.charCodeAt(s++);if(n&4294967168)if(!(n&4294965248))t+=2;else{if(n>=55296&&n<=56319&&s<e){let i=r.charCodeAt(s);(i&64512)===56320&&(++s,n=((n&1023)<<10)+(i&1023)+65536)}n&4294901760?t+=4:t+=3}else{t++;continue}}return t}function je(r,e,t){let s=r.length,n=t,i=0;for(;i<s;){let o=r.charCodeAt(i++);if(o&4294967168)if(!(o&4294965248))e[n++]=o>>6&31|192;else{if(o>=55296&&o<=56319&&i<s){let h=r.charCodeAt(i);(h&64512)===56320&&(++i,o=((o&1023)<<10)+(h&1023)+65536)}o&4294901760?(e[n++]=o>>18&7|240,e[n++]=o>>12&63|128,e[n++]=o>>6&63|128):(e[n++]=o>>12&15|224,e[n++]=o>>6&63|128)}else{e[n++]=o;continue}e[n++]=o&63|128}}var et=new TextEncoder,tt=50;function st(r,e,t){et.encodeInto(r,e.subarray(t))}function Be(r,e,t){r.length>tt?st(r,e,t):je(r,e,t)}var nt=4096;function Se(r,e,t){let s=e,n=s+t,i=[],o="";for(;s<n;){let h=r[s++];if(!(h&128))i.push(h);else if((h&224)===192){let g=r[s++]&63;i.push((h&31)<<6|g)}else if((h&240)===224){let g=r[s++]&63,w=r[s++]&63;i.push((h&31)<<12|g<<6|w)}else if((h&248)===240){let g=r[s++]&63,w=r[s++]&63,T=r[s++]&63,u=(h&7)<<18|g<<12|w<<6|T;u>65535&&(u-=65536,i.push(u>>>10&1023|55296),u=56320|u&1023),i.push(u)}else i.push(h);i.length>=nt&&(o+=String.fromCharCode(...i),i.length=0)}return i.length>0&&(o+=String.fromCharCode(...i)),o}var rt=new TextDecoder,it=200;function ot(r,e,t){let s=r.subarray(e,e+t);return rt.decode(s)}function Ie(r,e,t){return t>it?ot(r,e,t):Se(r,e,t)}var D=class{constructor(e,t){a(this,"type");a(this,"data");this.type=e,this.data=t}};var S=class r extends Error{constructor(e){super(e);let t=Object.create(r.prototype);Object.setPrototypeOf(this,t),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:r.name})}};function Ce(r,e,t){let s=t/4294967296,n=t;r.setUint32(e,s),r.setUint32(e+4,n)}function le(r,e,t){let s=Math.floor(t/4294967296),n=t;r.setUint32(e,s),r.setUint32(e+4,n)}function he(r,e){let t=r.getInt32(e),s=r.getUint32(e+4);return t*4294967296+s}function De(r,e){let t=r.getUint32(e),s=r.getUint32(e+4);return t*4294967296+s}var at=-1,ct=4294967296-1,lt=17179869184-1;function ht({sec:r,nsec:e}){if(r>=0&&e>=0&&r<=lt)if(e===0&&r<=ct){let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,r),t}else{let t=r/4294967296,s=r&4294967295,n=new Uint8Array(8),i=new DataView(n.buffer);return i.setUint32(0,e<<2|t&3),i.setUint32(4,s),n}else{let t=new Uint8Array(12),s=new DataView(t.buffer);return s.setUint32(0,e),le(s,4,r),t}}function dt(r){let e=r.getTime(),t=Math.floor(e/1e3),s=(e-t*1e3)*1e6,n=Math.floor(s/1e9);return{sec:t+n,nsec:s-n*1e9}}function ft(r){if(r instanceof Date){let e=dt(r);return ht(e)}else return null}function pt(r){let e=new DataView(r.buffer,r.byteOffset,r.byteLength);switch(r.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:{let t=e.getUint32(0),s=e.getUint32(4),n=(t&3)*4294967296+s,i=t>>>2;return{sec:n,nsec:i}}case 12:{let t=he(e,4),s=e.getUint32(0);return{sec:t,nsec:s}}default:throw new S(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${r.length}`)}}function ut(r){let e=pt(r);return new Date(e.sec*1e3+e.nsec/1e6)}var Re={type:at,encode:ft,decode:ut};var de=class de{constructor(){a(this,"__brand");a(this,"builtInEncoders",[]);a(this,"builtInDecoders",[]);a(this,"encoders",[]);a(this,"decoders",[]);this.register(Re)}register({type:e,encode:t,decode:s}){if(e>=0)this.encoders[e]=t,this.decoders[e]=s;else{let n=-1-e;this.builtInEncoders[n]=t,this.builtInDecoders[n]=s}}tryToEncode(e,t){for(let s=0;s<this.builtInEncoders.length;s++){let n=this.builtInEncoders[s];if(n!=null){let i=n(e,t);if(i!=null){let o=-1-s;return new D(o,i)}}}for(let s=0;s<this.encoders.length;s++){let n=this.encoders[s];if(n!=null){let i=n(e,t);if(i!=null){let o=s;return new D(o,i)}}}return e instanceof D?e:null}decode(e,t,s){let n=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return n?n(e,t,s):new D(t,e)}};a(de,"defaultCodec",new de);var W=de;function gt(r){return r instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&r instanceof SharedArrayBuffer}function ee(r){return r instanceof Uint8Array?r:ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):gt(r)?new Uint8Array(r):Uint8Array.from(r)}var xt=100,mt=2048,fe=class r{constructor(e){a(this,"extensionCodec");a(this,"context");a(this,"useBigInt64");a(this,"maxDepth");a(this,"initialBufferSize");a(this,"sortKeys");a(this,"forceFloat32");a(this,"ignoreUndefined");a(this,"forceIntegerToFloat");a(this,"pos");a(this,"view");a(this,"bytes");a(this,"entered",!1);this.extensionCodec=e?.extensionCodec??W.defaultCodec,this.context=e?.context,this.useBigInt64=e?.useBigInt64??!1,this.maxDepth=e?.maxDepth??xt,this.initialBufferSize=e?.initialBufferSize??mt,this.sortKeys=e?.sortKeys??!1,this.forceFloat32=e?.forceFloat32??!1,this.ignoreUndefined=e?.ignoreUndefined??!1,this.forceIntegerToFloat=e?.forceIntegerToFloat??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new r({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(e,t){if(t>this.maxDepth)throw new Error(`Too deep objects in depth ${t}`);e==null?this.encodeNil():typeof e=="boolean"?this.encodeBoolean(e):typeof e=="number"?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):typeof e=="string"?this.encodeString(e):this.useBigInt64&&typeof e=="bigint"?this.encodeBigInt64(e):this.encodeObject(e,t)}ensureBufferSizeToWrite(e){let t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(t*2)}resizeBuffer(e){let t=new ArrayBuffer(e),s=new Uint8Array(t),n=new DataView(t);s.set(this.bytes),this.view=n,this.bytes=s}encodeNil(){this.writeU8(192)}encodeBoolean(e){e===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<4294967296)this.writeU8(219),this.writeU32(e);else throw new Error(`Too long string: ${e} bytes in UTF-8`)}encodeString(e){let s=Le(e);this.ensureBufferSizeToWrite(5+s),this.writeStringHeader(s),Be(e,this.bytes,this.pos),this.pos+=s}encodeObject(e,t){let s=this.extensionCodec.tryToEncode(e,this.context);if(s!=null)this.encodeExtension(s);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if(typeof e=="object")this.encodeMap(e,t);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`)}encodeBinary(e){let t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<4294967296)this.writeU8(198),this.writeU32(t);else throw new Error(`Too large binary: ${t}`);let s=ee(e);this.writeU8a(s)}encodeArray(e,t){let s=e.length;if(s<16)this.writeU8(144+s);else if(s<65536)this.writeU8(220),this.writeU16(s);else if(s<4294967296)this.writeU8(221),this.writeU32(s);else throw new Error(`Too large array: ${s}`);for(let n of e)this.doEncode(n,t+1)}countWithoutUndefined(e,t){let s=0;for(let n of t)e[n]!==void 0&&s++;return s}encodeMap(e,t){let s=Object.keys(e);this.sortKeys&&s.sort();let n=this.ignoreUndefined?this.countWithoutUndefined(e,s):s.length;if(n<16)this.writeU8(128+n);else if(n<65536)this.writeU8(222),this.writeU16(n);else if(n<4294967296)this.writeU8(223),this.writeU32(n);else throw new Error(`Too large map object: ${n}`);for(let i of s){let o=e[i];this.ignoreUndefined&&o===void 0||(this.encodeString(i),this.doEncode(o,t+1))}}encodeExtension(e){if(typeof e.data=="function"){let s=e.data(this.pos+6),n=s.length;if(n>=4294967296)throw new Error(`Too large extension object: ${n}`);this.writeU8(201),this.writeU32(n),this.writeI8(e.type),this.writeU8a(s);return}let t=e.data.length;if(t===1)this.writeU8(212);else if(t===2)this.writeU8(213);else if(t===4)this.writeU8(214);else if(t===8)this.writeU8(215);else if(t===16)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else if(t<4294967296)this.writeU8(201),this.writeU32(t);else throw new Error(`Too large extension object: ${t}`);this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){let t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){this.ensureBufferSizeToWrite(8),Ce(this.view,this.pos,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),le(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}};function N(r,e){return new fe(e).encodeSharedRef(r)}function pe(r){return`${r<0?"-":""}0x${Math.abs(r).toString(16).padStart(2,"0")}`}var yt=16,wt=16,ue=class{constructor(e=yt,t=wt){a(this,"hit",0);a(this,"miss",0);a(this,"caches");a(this,"maxKeyLength");a(this,"maxLengthPerKey");this.maxKeyLength=e,this.maxLengthPerKey=t,this.caches=[];for(let s=0;s<this.maxKeyLength;s++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,t,s){let n=this.caches[s-1];e:for(let i of n){let o=i.bytes;for(let h=0;h<s;h++)if(o[h]!==e[t+h])continue e;return i.str}return null}store(e,t){let s=this.caches[e.length-1],n={bytes:e,str:t};s.length>=this.maxLengthPerKey?s[Math.random()*s.length|0]=n:s.push(n)}decode(e,t,s){let n=this.find(e,t,s);if(n!=null)return this.hit++,n;this.miss++;let i=Se(e,t,s),o=Uint8Array.prototype.slice.call(e,t,t+s);return this.store(o,i),i}};var Ue="array",ne="map_key",_e="map_value",vt=r=>{if(typeof r=="string"||typeof r=="number")return r;throw new S("The type of key must be string or number but "+typeof r)},be=class{constructor(){a(this,"stack",[]);a(this,"stackHeadPosition",-1)}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(e){let t=this.getUninitializedStateFromPool();t.type=Ue,t.position=0,t.size=e,t.array=new Array(e)}pushMapState(e){let t=this.getUninitializedStateFromPool();t.type=ne,t.readCount=0,t.size=e,t.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){let e={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(e)}return this.stack[this.stackHeadPosition]}release(e){if(this.stack[this.stackHeadPosition]!==e)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(e.type===Ue){let s=e;s.size=0,s.array=void 0,s.position=0,s.type=void 0}if(e.type===ne||e.type===_e){let s=e;s.size=0,s.map=void 0,s.readCount=0,s.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}},se=-1,Ee=new DataView(new ArrayBuffer(0)),Tt=new Uint8Array(Ee.buffer);try{Ee.getInt8(0)}catch(r){if(!(r instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}var ze=new RangeError("Insufficient data"),St=new ue,ge=class r{constructor(e){a(this,"extensionCodec");a(this,"context");a(this,"useBigInt64");a(this,"rawStrings");a(this,"maxStrLength");a(this,"maxBinLength");a(this,"maxArrayLength");a(this,"maxMapLength");a(this,"maxExtLength");a(this,"keyDecoder");a(this,"mapKeyConverter");a(this,"totalPos",0);a(this,"pos",0);a(this,"view",Ee);a(this,"bytes",Tt);a(this,"headByte",se);a(this,"stack",new be);a(this,"entered",!1);this.extensionCodec=e?.extensionCodec??W.defaultCodec,this.context=e?.context,this.useBigInt64=e?.useBigInt64??!1,this.rawStrings=e?.rawStrings??!1,this.maxStrLength=e?.maxStrLength??4294967295,this.maxBinLength=e?.maxBinLength??4294967295,this.maxArrayLength=e?.maxArrayLength??4294967295,this.maxMapLength=e?.maxMapLength??4294967295,this.maxExtLength=e?.maxExtLength??4294967295,this.keyDecoder=e?.keyDecoder!==void 0?e.keyDecoder:St,this.mapKeyConverter=e?.mapKeyConverter??vt}clone(){return new r({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=se,this.stack.reset()}setBuffer(e){let t=ee(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}appendBuffer(e){if(this.headByte===se&&!this.hasRemaining(1))this.setBuffer(e);else{let t=this.bytes.subarray(this.pos),s=ee(e),n=new Uint8Array(t.length+s.length);n.set(t),n.set(s,t.length),this.setBuffer(n)}}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){let{view:t,pos:s}=this;return new RangeError(`Extra ${t.byteLength-s} of ${t.byteLength} byte(s) found at buffer[${e}]`)}decode(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);let t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}*decodeMulti(e){if(this.entered){yield*this.clone().decodeMulti(e);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(e){if(this.entered)return this.clone().decodeAsync(e);try{this.entered=!0;let t=!1,s;for await(let h of e){if(t)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(h);try{s=this.doDecodeSync(),t=!0}catch(g){if(!(g instanceof RangeError))throw g}this.totalPos+=this.pos}if(t){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return s}let{headByte:n,pos:i,totalPos:o}=this;throw new RangeError(`Insufficient data in parsing ${pe(n)} at ${o} (${i} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async*decodeMultiAsync(e,t){if(this.entered){yield*this.clone().decodeMultiAsync(e,t);return}try{this.entered=!0;let s=t,n=-1;for await(let i of e){if(t&&n===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(i),s&&(n=this.readArraySize(),s=!1,this.complete());try{for(;yield this.doDecodeSync(),--n!==0;);}catch(o){if(!(o instanceof RangeError))throw o}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){e:for(;;){let e=this.readHeadByte(),t;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){let n=e-128;if(n!==0){this.pushMapState(n),this.complete();continue e}else t={}}else if(e<160){let n=e-144;if(n!==0){this.pushArrayState(n),this.complete();continue e}else t=[]}else{let n=e-160;t=this.decodeString(n,0)}else if(e===192)t=null;else if(e===194)t=!1;else if(e===195)t=!0;else if(e===202)t=this.readF32();else if(e===203)t=this.readF64();else if(e===204)t=this.readU8();else if(e===205)t=this.readU16();else if(e===206)t=this.readU32();else if(e===207)this.useBigInt64?t=this.readU64AsBigInt():t=this.readU64();else if(e===208)t=this.readI8();else if(e===209)t=this.readI16();else if(e===210)t=this.readI32();else if(e===211)this.useBigInt64?t=this.readI64AsBigInt():t=this.readI64();else if(e===217){let n=this.lookU8();t=this.decodeString(n,1)}else if(e===218){let n=this.lookU16();t=this.decodeString(n,2)}else if(e===219){let n=this.lookU32();t=this.decodeString(n,4)}else if(e===220){let n=this.readU16();if(n!==0){this.pushArrayState(n),this.complete();continue e}else t=[]}else if(e===221){let n=this.readU32();if(n!==0){this.pushArrayState(n),this.complete();continue e}else t=[]}else if(e===222){let n=this.readU16();if(n!==0){this.pushMapState(n),this.complete();continue e}else t={}}else if(e===223){let n=this.readU32();if(n!==0){this.pushMapState(n),this.complete();continue e}else t={}}else if(e===196){let n=this.lookU8();t=this.decodeBinary(n,1)}else if(e===197){let n=this.lookU16();t=this.decodeBinary(n,2)}else if(e===198){let n=this.lookU32();t=this.decodeBinary(n,4)}else if(e===212)t=this.decodeExtension(1,0);else if(e===213)t=this.decodeExtension(2,0);else if(e===214)t=this.decodeExtension(4,0);else if(e===215)t=this.decodeExtension(8,0);else if(e===216)t=this.decodeExtension(16,0);else if(e===199){let n=this.lookU8();t=this.decodeExtension(n,1)}else if(e===200){let n=this.lookU16();t=this.decodeExtension(n,2)}else if(e===201){let n=this.lookU32();t=this.decodeExtension(n,4)}else throw new S(`Unrecognized type byte: ${pe(e)}`);this.complete();let s=this.stack;for(;s.length>0;){let n=s.top();if(n.type===Ue)if(n.array[n.position]=t,n.position++,n.position===n.size)t=n.array,s.release(n);else continue e;else if(n.type===ne){if(t==="__proto__")throw new S("The key __proto__ is not allowed");n.key=this.mapKeyConverter(t),n.type=_e;continue e}else if(n.map[n.key]=t,n.readCount++,n.readCount===n.size)t=n.map,s.release(n);else{n.key=null,n.type=ne;continue e}}return t}}readHeadByte(){return this.headByte===se&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=se}readArraySize(){let e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:{if(e<160)return e-144;throw new S(`Unrecognized array type byte: ${pe(e)}`)}}}pushMapState(e){if(e>this.maxMapLength)throw new S(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(e)}pushArrayState(e){if(e>this.maxArrayLength)throw new S(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(e)}decodeString(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}decodeUtf8String(e,t){if(e>this.maxStrLength)throw new S(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+t+e)throw ze;let s=this.pos+t,n;return this.stateIsMapKey()&&this.keyDecoder?.canBeCached(e)?n=this.keyDecoder.decode(this.bytes,s,e):n=Ie(this.bytes,s,e),this.pos+=t+e,n}stateIsMapKey(){return this.stack.length>0?this.stack.top().type===ne:!1}decodeBinary(e,t){if(e>this.maxBinLength)throw new S(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+t))throw ze;let s=this.pos+t,n=this.bytes.subarray(s,s+e);return this.pos+=t+e,n}decodeExtension(e,t){if(e>this.maxExtLength)throw new S(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);let s=this.view.getInt8(this.pos+t),n=this.decodeBinary(e,t+1);return this.extensionCodec.decode(n,s,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){let e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){let e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){let e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){let e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){let e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){let e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){let e=De(this.view,this.pos);return this.pos+=8,e}readI64(){let e=he(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){let e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){let e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){let e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){let e=this.view.getFloat64(this.pos);return this.pos+=8,e}};function R(r,e){return new ge(e).decode(r)}var O=class extends k{constructor(t){super();this.name="WebSocket";this.socket=null;this.reconnectAttempts=0;this.maxReconnectDelay=5e3;this.shouldReconnect=!0;this.url=t||this.getDefaultUrl()}getDefaultUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_pyhtml/ws`}connect(){return new Promise((t,s)=>{try{this.socket=new WebSocket(this.url),this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{console.log("PyHTML: WebSocket connected"),this.notifyStatus(!0),this.reconnectAttempts=0,t()},this.socket.onmessage=n=>{try{let i=R(n.data);this.notifyHandlers(i)}catch(i){console.error("PyHTML: Error parsing WebSocket message",i)}},this.socket.onclose=()=>{console.log("PyHTML: WebSocket disconnected"),this.notifyStatus(!1),this.shouldReconnect&&this.scheduleReconnect()},this.socket.onerror=n=>{console.error("PyHTML: WebSocket error",n),this.connected||s(new Error("WebSocket connection failed"))}}catch(n){s(n)}})}send(t){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(N(t)):console.warn("PyHTML: Cannot send message, WebSocket not open")}disconnect(){this.shouldReconnect=!1,this.socket&&(this.socket.close(),this.socket=null),this.notifyStatus(!1)}scheduleReconnect(){let t=Math.min(1e3*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);console.log(`PyHTML: Reconnecting in ${t}ms...`),setTimeout(()=>{this.reconnectAttempts++,this.connect().catch(()=>{})},t)}};var K=class extends k{constructor(t){super();this.name="HTTP";this.polling=!1;this.pollAbortController=null;this.sessionId=null;this.baseUrl=t||`${window.location.origin}/_pyhtml`}async connect(){try{let t=await fetch(`${this.baseUrl}/session`,{method:"POST",headers:{"Content-Type":"application/x-msgpack",Accept:"application/x-msgpack"},body:N({path:window.location.pathname+window.location.search})});if(!t.ok)throw new Error(`HTTP session init failed: ${t.status}`);let s=await t.arrayBuffer(),n=R(s);this.sessionId=n.sessionId,console.log("PyHTML: HTTP transport connected"),this.notifyStatus(!0),this.startPolling()}catch(t){throw console.error("PyHTML: HTTP transport connection failed",t),t}}async startPolling(){if(!this.polling)for(this.polling=!0;this.polling&&this.connected;)try{this.pollAbortController=new AbortController;let t=await fetch(`${this.baseUrl}/poll?session=${this.sessionId}`,{method:"GET",signal:this.pollAbortController.signal,headers:{Accept:"application/x-msgpack"}});if(!t.ok){if(t.status===404){console.warn("PyHTML: HTTP session expired, reconnecting..."),this.notifyStatus(!1),await this.connect();return}throw new Error(`Poll failed: ${t.status}`)}let s=await t.arrayBuffer(),n=R(s);for(let i of n)this.notifyHandlers(i)}catch(t){if(t instanceof Error&&t.name==="AbortError")break;console.error("PyHTML: HTTP poll error",t),await this.sleep(1e3)}}async send(t){if(!this.connected||!this.sessionId){console.warn("PyHTML: Cannot send message, HTTP transport not connected");return}try{let s=await fetch(`${this.baseUrl}/event`,{method:"POST",headers:{"Content-Type":"application/x-msgpack",Accept:"application/x-msgpack","X-PyHTML-Session":this.sessionId},body:N(t)});if(!s.ok)throw new Error(`Event send failed: ${s.status}`);let n=await s.arrayBuffer(),i=R(n);this.notifyHandlers(i)}catch(s){console.error("PyHTML: HTTP send error",s)}}disconnect(){this.polling=!1,this.notifyStatus(!1),this.pollAbortController&&(this.pollAbortController.abort(),this.pollAbortController=null),this.sessionId=null}sleep(t){return new Promise(s=>setTimeout(s,t))}};var Ut={enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},V=class{constructor(e={}){this.transport=null;this.messageHandlers=[];this.statusHandlers=[];this.config={...Ut,...e}}async connect(){let e=this.getTransportPriority();for(let t of e)try{console.log(`PyHTML: Trying ${t.name}...`),this.transport=new t;for(let s of this.messageHandlers)this.transport.onMessage(s);this.transport.onStatusChange(s=>{this.notifyStatusHandlers(s)}),await this.transport.connect(),console.log(`PyHTML: Connected via ${this.transport.name}`);return}catch(s){console.warn(`PyHTML: ${t.name} failed, trying next...`,s),this.transport=null}throw new Error("PyHTML: All transports failed")}getTransportPriority(){let e=[];return this.config.enableWebTransport&&C.isSupported()&&window.location.protocol==="https:"&&e.push(C),this.config.enableWebSocket&&typeof WebSocket<"u"&&e.push(O),this.config.enableHTTP&&e.push(K),e}send(e){this.transport?this.transport.send(e):console.warn("PyHTML: No active transport")}onMessage(e){this.messageHandlers.push(e),this.transport&&this.transport.onMessage(e)}onStatusChange(e){this.statusHandlers.push(e)}notifyStatusHandlers(e){for(let t of this.statusHandlers)t(e)}disconnect(){this.transport&&(this.transport.disconnect(),this.transport=null,this.notifyStatusHandlers(!1))}getActiveTransport(){return this.transport?.name||null}isConnected(){return this.transport?.isConnected()||!1}};var $e=11;function bt(r,e){var t=e.attributes,s,n,i,o,h;if(!(e.nodeType===$e||r.nodeType===$e)){for(var g=t.length-1;g>=0;g--)s=t[g],n=s.name,i=s.namespaceURI,o=s.value,i?(n=s.localName||n,h=r.getAttributeNS(i,n),h!==o&&(s.prefix==="xmlns"&&(n=s.name),r.setAttributeNS(i,n,o))):(h=r.getAttribute(n),h!==o&&r.setAttribute(n,o));for(var w=r.attributes,T=w.length-1;T>=0;T--)s=w[T],n=s.name,i=s.namespaceURI,i?(n=s.localName||n,e.hasAttributeNS(i,n)||r.removeAttributeNS(i,n)):e.hasAttribute(n)||r.removeAttribute(n)}}var xe,Et="http://www.w3.org/1999/xhtml",U=typeof document>"u"?void 0:document,At=!!U&&"content"in U.createElement("template"),Mt=!!U&&U.createRange&&"createContextualFragment"in U.createRange();function Pt(r){var e=U.createElement("template");return e.innerHTML=r,e.content.childNodes[0]}function kt(r){xe||(xe=U.createRange(),xe.selectNode(U.body));var e=xe.createContextualFragment(r);return e.childNodes[0]}function Ht(r){var e=U.createElement("body");return e.innerHTML=r,e.childNodes[0]}function Lt(r){return r=r.trim(),At?Pt(r):Mt?kt(r):Ht(r)}function me(r,e){var t=r.nodeName,s=e.nodeName,n,i;return t===s?!0:(n=t.charCodeAt(0),i=s.charCodeAt(0),n<=90&&i>=97?t===s.toUpperCase():i<=90&&n>=97?s===t.toUpperCase():!1)}function Bt(r,e){return!e||e===Et?U.createElement(r):U.createElementNS(e,r)}function It(r,e){for(var t=r.firstChild;t;){var s=t.nextSibling;e.appendChild(t),t=s}return e}function Ae(r,e,t){r[t]!==e[t]&&(r[t]=e[t],r[t]?r.setAttribute(t,""):r.removeAttribute(t))}var Fe={OPTION:function(r,e){var t=r.parentNode;if(t){var s=t.nodeName.toUpperCase();s==="OPTGROUP"&&(t=t.parentNode,s=t&&t.nodeName.toUpperCase()),s==="SELECT"&&!t.hasAttribute("multiple")&&(r.hasAttribute("selected")&&!e.selected&&(r.setAttribute("selected","selected"),r.removeAttribute("selected")),t.selectedIndex=-1)}Ae(r,e,"selected")},INPUT:function(r,e){Ae(r,e,"checked"),Ae(r,e,"disabled"),r.value!==e.value&&(r.value=e.value),e.hasAttribute("value")||r.removeAttribute("value")},TEXTAREA:function(r,e){var t=e.value;r.value!==t&&(r.value=t);var s=r.firstChild;if(s){var n=s.nodeValue;if(n==t||!t&&n==r.placeholder)return;s.nodeValue=t}},SELECT:function(r,e){if(!e.hasAttribute("multiple")){for(var t=-1,s=0,n=r.firstChild,i,o;n;)if(o=n.nodeName&&n.nodeName.toUpperCase(),o==="OPTGROUP")i=n,n=i.firstChild,n||(n=i.nextSibling,i=null);else{if(o==="OPTION"){if(n.hasAttribute("selected")){t=s;break}s++}n=n.nextSibling,!n&&i&&(n=i.nextSibling,i=null)}r.selectedIndex=t}}},re=1,We=11,Ne=3,Oe=8;function H(){}function Ct(r){if(r)return r.getAttribute&&r.getAttribute("id")||r.id}function Dt(r){return function(t,s,n){if(n||(n={}),typeof s=="string")if(t.nodeName==="#document"||t.nodeName==="HTML"||t.nodeName==="BODY"){var i=s;s=U.createElement("html"),s.innerHTML=i}else s=Lt(s);else s.nodeType===We&&(s=s.firstElementChild);var o=n.getNodeKey||Ct,h=n.onBeforeNodeAdded||H,g=n.onNodeAdded||H,w=n.onBeforeElUpdated||H,T=n.onElUpdated||H,u=n.onBeforeNodeDiscarded||H,E=n.onNodeDiscarded||H,L=n.onBeforeElChildrenUpdated||H,z=n.skipFromChildren||H,Z=n.addChild||function(c,l){return c.appendChild(l)},Q=n.childrenOnly===!0,b=Object.create(null),m=[];function x(c){m.push(c)}function j(c,l){if(c.nodeType===re)for(var p=c.firstChild;p;){var d=void 0;l&&(d=o(p))?x(d):(E(p),p.firstChild&&j(p,l)),p=p.nextSibling}}function B(c,l,p){u(c)!==!1&&(l&&l.removeChild(c),E(c),j(c,p))}function y(c){if(c.nodeType===re||c.nodeType===We)for(var l=c.firstChild;l;){var p=o(l);p&&(b[p]=l),y(l),l=l.nextSibling}}y(t);function _(c){g(c);for(var l=c.firstChild;l;){var p=l.nextSibling,d=o(l);if(d){var f=b[d];f&&me(l,f)?(l.parentNode.replaceChild(f,l),I(f,l)):_(l)}else _(l);l=p}}function ye(c,l,p){for(;l;){var d=l.nextSibling;(p=o(l))?x(p):B(l,c,!0),l=d}}function I(c,l,p){var d=o(l);if(d&&delete b[d],!p){var f=w(c,l);if(f===!1||(f instanceof HTMLElement&&(c=f,y(c)),r(c,l),T(c),L(c,l)===!1))return}c.nodeName!=="TEXTAREA"?Ke(c,l):Fe.TEXTAREA(c,l)}function Ke(c,l){var p=z(c,l),d=l.firstChild,f=c.firstChild,$,A,F,oe,M;e:for(;d;){for(oe=d.nextSibling,$=o(d);!p&&f;){if(F=f.nextSibling,d.isSameNode&&d.isSameNode(f)){d=oe,f=F;continue e}A=o(f);var ae=f.nodeType,P=void 0;if(ae===d.nodeType&&(ae===re?($?$!==A&&((M=b[$])?F===M?P=!1:(c.insertBefore(M,f),A?x(A):B(f,c,!0),f=M,A=o(f)):P=!1):A&&(P=!1),P=P!==!1&&me(f,d),P&&I(f,d)):(ae===Ne||ae==Oe)&&(P=!0,f.nodeValue!==d.nodeValue&&(f.nodeValue=d.nodeValue))),P){d=oe,f=F;continue e}A?x(A):B(f,c,!0),f=F}if($&&(M=b[$])&&me(M,d))p||Z(c,M),I(M,d);else{var Te=h(d);Te!==!1&&(Te&&(d=Te),d.actualize&&(d=d.actualize(c.ownerDocument||U)),Z(c,d),_(d))}d=oe,f=F}ye(c,f,A);var He=Fe[c.nodeName];He&&He(c,l)}var v=t,ie=v.nodeType,ke=s.nodeType;if(!Q){if(ie===re)ke===re?me(t,s)||(E(t),v=It(t,Bt(s.nodeName,s.namespaceURI))):v=s;else if(ie===Ne||ie===Oe){if(ke===ie)return v.nodeValue!==s.nodeValue&&(v.nodeValue=s.nodeValue),v;v=s}}if(v===s)E(t);else{if(s.isSameNode&&s.isSameNode(v))return;if(I(v,s,Q),m)for(var we=0,Ve=m.length;we<Ve;we++){var ve=b[m[we]];ve&&B(ve,ve.parentNode,!1)}}return!Q&&v!==t&&t.parentNode&&(v.actualize&&(v=v.actualize(t.ownerDocument||U)),t.parentNode.replaceChild(v,t)),v}}var Rt=Dt(bt),Me=Rt;var X=class{update(e){Me?Me(document.documentElement,e,{onBeforeElUpdated:(t,s)=>{if(t===document.activeElement&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA")){let n=s.getAttribute("value")||"",i=t.value||"";(i.startsWith(n)||n.startsWith(i))&&(s.setAttribute("value",i),s.value=i,t.tagName==="TEXTAREA"&&(s.textContent=i))}return!0}}):(document.open(),document.write(e),document.close())}};var zt={autoInit:!0,enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},G=class{constructor(e={}){this.initialized=!1;this.siblingPaths=[];this.pathRegexes=[];this.pjaxEnabled=!1;this.isConnected=!1;this.config={...zt,...e},this.transport=new V(this.config),this.updater=new X}async init(){if(!this.initialized){this.initialized=!0,this.transport.onMessage(e=>this.handleMessage(e)),this.transport.onStatusChange(e=>this.handleStatusChange(e));try{await this.transport.connect()}catch(e){console.error("PyHTML: Failed to connect:",e)}this.loadSPAMetadata(),this.setupSPANavigation(),this.setupEventInterceptors(),console.log(`PyHTML: Initialized (transport: ${this.transport.getActiveTransport()}, spa_paths: ${this.siblingPaths.length}, pjax: ${this.pjaxEnabled})`)}}handleStatusChange(e){this.isConnected=e}loadSPAMetadata(){let e=document.getElementById("_pyhtml_spa_meta");if(e)try{let t=JSON.parse(e.textContent||"{}");this.siblingPaths=t.sibling_paths||[],this.pjaxEnabled=!!t.enable_pjax,this.pathRegexes=this.siblingPaths.map(s=>this.patternToRegex(s))}catch(t){console.warn("PyHTML: Failed to parse SPA metadata",t)}}patternToRegex(e){let t=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&");return t=t.replace(/:(\\w+)(:\\w+)?/g,"([^/]+)"),t=t.replace(/\\{(\\w+)(:\\w+)?\\}/g,"([^/]+)"),new RegExp(`^${t}$`)}isSiblingPath(e){return this.pathRegexes.some(t=>t.test(e))}setupSPANavigation(){window.addEventListener("popstate",()=>{this.sendRelocate(window.location.pathname+window.location.search)}),!(this.siblingPaths.length===0&&!this.pjaxEnabled)&&document.addEventListener("click",e=>{let t=e.target.closest("a[href]");if(!t||t.origin!==window.location.origin||t.hasAttribute("download")||t.target==="_blank")return;let s=!1;(this.pjaxEnabled||this.isSiblingPath(t.pathname))&&(s=!0),s&&(e.preventDefault(),this.navigateTo(t.pathname+t.search))})}navigateTo(e){if(!this.isConnected){console.warn("PyHTML: Navigation blocked - Offline");return}history.pushState({},"",e),this.sendRelocate(e)}sendRelocate(e){let t={type:"relocate",path:e};this.transport.send(t)}setupEventInterceptors(){document.addEventListener("click",t=>{let s=t.target.closest("[data-on-click]");if(s){t.preventDefault();let n=s.getAttribute("data-on-click");n&&this.sendEvent(n,{type:"click",id:s.id,value:s.value,args:this.getArgs(s)})}}),document.addEventListener("submit",async t=>{let s=t.target.closest("[data-on-submit]");if(s){t.preventDefault();let n=s.getAttribute("data-on-submit");if(n){let i=s,o=new FormData(i),h={};o.forEach((T,u)=>{T instanceof File||(h[u]=T.toString())});let g=i.querySelectorAll('input[type="file"]'),w=[];g.forEach(T=>{let u=T,E=u.name;if(E&&u.files&&u.files.length>0){let L=u.files[0],z=u.getAttribute("max-size");if(z){let b=parseInt(z),m=z.toLowerCase();if(m.endsWith("kb")||m.endsWith("k")?b=parseInt(m)*1024:m.endsWith("mb")||m.endsWith("m")?b=parseInt(m)*1024*1024:(m.endsWith("gb")||m.endsWith("g"))&&(b=parseInt(m)*1024*1024*1024),L.size>b){let x=`File is too large. Max size is ${z}.`;alert(x),w.push(Promise.reject(x));return}}let Z=new FormData;Z.append(E,L);let Q=new Promise((b,m)=>{let x=new XMLHttpRequest;x.open("POST","/_pyhtml/upload");let j=document.querySelector('meta[name="pyhtml-upload-token"]');if(j){let y=j.getAttribute("content");y&&x.setRequestHeader("X-Upload-Token",y)}let B=0;x.upload.onprogress=y=>{if(y.lengthComputable){let _=Date.now();if(_-B>=100){B=_;let ye=y.loaded/y.total,I=u.getAttribute("data-on-upload-progress");I&&this.sendEvent(I,{type:"upload-progress",id:u.id,progress:ye,args:this.getArgs(u)})}}},x.onload=()=>{if(x.status>=200&&x.status<300)try{let y=JSON.parse(x.responseText);y[E]?(h[E]={_upload_id:y[E],name:L.name,type:L.type,size:L.size},b()):m(new Error("No ID returned"))}catch(y){m(y)}else{let y=`Upload failed: ${x.status} ${x.statusText}`;alert(y),m(new Error(y))}},x.onerror=()=>m(x.statusText),x.send(Z)});w.push(Q)}});try{await Promise.all(w)}catch(T){console.error("PyHTML: Upload failed",T);return}this.sendEvent(n,{type:"submit",id:s.id,formData:h,args:this.getArgs(s)})}}});let e;document.addEventListener("input",t=>{let s=t.target.closest("[data-on-input]");s&&(clearTimeout(e),e=window.setTimeout(()=>{let n=s.getAttribute("data-on-input");n&&this.sendEvent(n,{type:"input",id:s.id,value:s.value,args:this.getArgs(s)})},150))}),document.addEventListener("change",t=>{let s=t.target.closest("[data-on-change]");if(s){let n=s.getAttribute("data-on-change");n&&this.sendEvent(n,{type:"change",id:s.id,value:s.value,checked:s.checked,args:this.getArgs(s)})}})}getArgs(e){let t={};if(e instanceof HTMLElement){for(let s in e.dataset)if(s.startsWith("arg"))try{t[s]=JSON.parse(e.dataset[s]||"null")}catch{t[s]=e.dataset[s]}}return t}sendEvent(e,t){let s={type:"event",handler:e,path:window.location.pathname+window.location.search,data:t};this.transport.send(s)}async handleMessage(e){switch(e.type){case"update":e.html&&this.updater.update(e.html);break;case"reload":console.log("PyHTML: Reloading..."),window.location.reload();break;case"error":console.error("PyHTML: Server error:",e.error);break;case"error_trace":console.error("PyHTML: Error:",e.error);break;case"console":if(e.lines&&e.lines.length>0){let t="PyHTML Server:",s=e.lines.join(`
`);e.level==="error"?console.error(t,s):e.level==="warn"?console.warn(t,s):console.log(t,s)}break;default:console.warn("PyHTML: Unknown message type",e)}}getTransport(){return this.transport.getActiveTransport()}disconnect(){this.transport.disconnect()}};var Y=class{constructor(){this.element=null;this.create()}create(){this.element=document.createElement("div"),this.element.style.cssText=`
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 14px;
            z-index: 10000;
            display: none;
            transition: opacity 0.3s;
            pointer-events: none;
        `,document.body.appendChild(this.element)}update(e){this.element&&(e?this.element.style.display="none":(this.element.textContent="Connection Lost - Reconnecting...",this.element.style.display="block",this.element.style.backgroundColor="rgba(0, 0, 0, 0.8)"))}showNavigationBlocked(){this.element&&(this.element.style.backgroundColor="rgba(200, 0, 0, 0.9)",this.element.textContent="Cannot navigate - Offline",this.element.style.display="block",setTimeout(()=>{this.element&&(this.element.style.backgroundColor="rgba(0, 0, 0, 0.8)")},1500))}};var J=class{constructor(){this.loadedSources=new Set}getVirtualUrl(e){let t=btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),s=e.split(/[/\\]/).pop()||"unknown";return`${window.location.origin}/_pyhtml/file/${t}/${s}`}async handle(e,t){let s=new Set;for(let o of t)this.loadedSources.has(o.filename)||s.add(o.filename);await Promise.all(Array.from(s).map(async o=>{try{let h=this.getVirtualUrl(o),g=`/_pyhtml/source?path=${encodeURIComponent(o)}`,w=await fetch(g);if(w.ok){let u=`${await w.text()}
//# sourceURL=${h}`;try{(0,eval)(u)}catch{}this.loadedSources.add(o)}this.loadedSources.add(o)}catch(h){console.warn("PyHTML: Failed to load source",o,h)}}));let n=new Error(e),i=[`${n.name}: ${n.message}`];for(let o of t){let h=o.name||"<module>",g=this.getVirtualUrl(o.filename),w=o.colno??1;i.push(`    at ${h} (${g}:${o.lineno}:${w})`)}n.stack=i.join(`
`),console.error(n.stack)}};var q=class extends G{constructor(t={}){super(t);this.overlay=null;this.errorHandler=new J}async init(){this.overlay=new Y,await super.init()}handleStatusChange(t){super.handleStatusChange(t),this.overlay&&this.overlay.update(t)}navigateTo(t){if(!this.isConnected){console.warn("PyHTML: Navigation blocked - Offline"),this.overlay&&this.overlay.showNavigationBlocked();return}super.navigateTo(t)}async handleMessage(t){switch(t.type){case"error_trace":t.trace&&await this.errorHandler.handle(t.error||"Unknown Error",t.trace);return;case"console":if(t.lines&&t.lines.length>0){let s="PyHTML Server:",n=t.lines.join(`
`);t.level==="error"?(console.group(s+" Error"),console.error(n),console.groupEnd()):t.level==="warn"?(console.groupCollapsed(s+" Warning"),console.warn(n),console.groupEnd()):t.lines.length===1?console.log(s,n):(console.groupCollapsed(s+" Log"),console.log(n),console.groupEnd())}return;default:await super.handleMessage(t)}}};var Pe=new q;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>Pe.init()):Pe.init();return Qe(_t);})();
